<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Longdo Map + Firebase</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) */
        .map-section {
            flex: 2;
            position: relative;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220,38,38,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220,38,38,0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° crosshair ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
        .center-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
        }
        
        .crosshair-h {
            width: 30px;
            height: 2px;
            background: #dc2626;
            position: absolute;
            left: -15px;
            top: -1px;
            box-shadow: 0 0 3px rgba(255,255,255,0.8);
        }
        
        .crosshair-v {
            width: 2px;
            height: 30px;
            background: #dc2626;
            position: absolute;
            left: -1px;
            top: -15px;
            box-shadow: 0 0 3px rgba(255,255,255,0.8);
        }
        
        .crosshair-center {
            width: 6px;
            height: 6px;
            background: #dc2626;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            left: -3px;
            top: -3px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ç‡∏ß‡∏≤) */
        .form-section {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
            min-width: 350px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 80px;
            resize: vertical;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
        }
        
        .btn-form {
            width: 100%;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .btn-form:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5,150,105,0.3);
        }
        
        .btn-form:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .coordinate-display {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }
        
        .coordinate-display h4 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .coordinate-text {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .markers-list {
            margin-top: 30px;
        }
        
        .markers-list h3 {
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .marker-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .marker-item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .marker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .marker-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .marker-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .marker-capacity {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #9ca3af;
        }
        
        .empty-state p {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group .form-input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
    <script type="text/javascript" src="https://api.longdo.com/map3/?key=417740672e7626cdcd09c2756d411dde"></script>
</head>
<body onload="init();">
    <div class="container">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="map-section">
            <div id="map"></div>
            <div class="center-crosshair">
                <div class="crosshair-h"></div>
                <div class="crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            <div class="status" id="status">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ç‡∏ß‡∏≤) -->
        <div class="form-section">
            <div class="form-group">
                <button type="button" class="btn-form" style="background: linear-gradient(135deg, #dc2626, #ef4444);" onclick="markCenterPosition()">
                    üìç ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                </button>
            </div>

            <div class="coordinate-display" id="coordinateDisplay">
                <h4>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
                <div class="coordinate-text" id="currentCoordinate">
                    ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î
                </div>
            </div>

            <form id="markerForm">
                <div class="form-group">
                    <label class="form-label" for="markerName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
                    <input type="text" id="markerName" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ABC" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="markerAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <textarea id="markerAddress" class="form-textarea" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="markerCapacity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ</label>
                    <input type="number" id="markerCapacity" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50" min="1">
                </div>
                <button type="submit" class="btn-form" id="addMarkerBtn">
                    ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </form>

            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="loadMarkersFromFirebase()">
                    üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
                </button>
                <button type="button" class="btn-secondary" onclick="clearAllMarkers()">
                    üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>

            <div class="markers-list">
                <h3>üìå ‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="markerCount">0</span>)</h3>
                <div id="markersList">
                    <div class="empty-state">
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î</p>
                        <p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏£‡∏Å!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRCO-wzB0sKIjGXw_IPJGSnjcw00ZBGME",
            authDomain: "testlongdomap.firebaseapp.com",
            projectId: "testlongdomap",
            storageBucket: "testlongdomap.firebasestorage.app",
            messagingSenderId: "391627017137",
            appId: "1:391627017137:web:8221c2540c136bccaf0b90",
            measurementId: "G-BE75QETT05"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;

        // Update status when Firebase is ready
        window.addEventListener('load', function() {
            setTimeout(function() {
                updateStatus('‚úÖ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î');
                
                // Auto-load markers on startup
                loadMarkersFromFirebase();
            }, 1000);
        });
    </script>

    <script>
        var map;
        var markers = [];
        var currentLat = 13.736717;
        var currentLon = 100.523186;

        function init() {
            try {
                if (typeof longdo === 'undefined') {
                    setTimeout(init, 500);
                    return;
                }

                map = new longdo.Map({
                    placeholder: document.getElementById('map'),
                    language: 'th'
                });

                map.location({ lon: currentLon, lat: currentLat });
                map.zoom(6);

                map.Event.bind('moveend', updateCurrentCoordinate);
                updateCurrentCoordinate();
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...');
            } catch (error) {
                updateStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ' + error.message);
            }
        }

        function updateCurrentCoordinate() {
            try {
                var centerLocation = map.location();
                if (centerLocation) {
                    currentLat = centerLocation.lat;
                    currentLon = centerLocation.lon;
                    document.getElementById('currentCoordinate').innerHTML =
                        '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ' + currentLat.toFixed(6) + '<br>' +
                        '‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: ' + currentLon.toFixed(6);
                }
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }

        function markCenterPosition() {
            try {
                var center = map.location();
                currentLat = center.lat;
                currentLon = center.lon;
                updateCurrentCoordinate();
                updateStatus('üìç ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"');
            } catch (error) {
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        document.getElementById('markerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addMarkerWithData();
        });

        async function addMarkerWithData() {
            try {
                var name = document.getElementById('markerName').value.trim();
                var address = document.getElementById('markerAddress').value.trim();
                var capacity = document.getElementById('markerCapacity').value;

                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
                    return;
                }

                // Show loading
                var addBtn = document.getElementById('addMarkerBtn');
                var originalText = addBtn.textContent;
                addBtn.textContent = 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                addBtn.disabled = true;

                var markerData = {
                    name: name,
                    address: address,
                    capacity: capacity ? parseInt(capacity) : null,
                    lat: currentLat,
                    lon: currentLon,
                    createdAt: new Date(),
                    timestamp: Date.now()
                };

                // Save to Firebase Firestore
                const docRef = await window.addDoc(window.collection(window.db, "markers"), markerData);
                console.log("Document written with ID: ", docRef.id);

                // Add marker to map
                var marker = new longdo.Marker({ lon: currentLon, lat: currentLat }, {
                    title: name,
                    detail: address || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'
                });

                map.Overlays.add(marker);
                
                // Add to local array with Firebase ID
                markerData.id = docRef.id;
                markerData.marker = marker;
                markerData.createdAt = markerData.createdAt.toLocaleString('th-TH');
                markers.push(markerData);

                updateMarkersList();
                clearForm();
                updateStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "' + name + '" ‡πÉ‡∏ô Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

                // Reset button
                addBtn.textContent = originalText;
                addBtn.disabled = false;

            } catch (error) {
                console.error("Error adding document: ", error);
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
                
                // Reset button on error
                var addBtn = document.getElementById('addMarkerBtn');
                addBtn.textContent = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                addBtn.disabled = false;
            }
        }

        async function loadMarkersFromFirebase() {
            try {
                updateStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...');
                
                // Clear existing markers
                markers.forEach(function(markerData) {
                    if (markerData.marker) {
                        map.Overlays.remove(markerData.marker);
                    }
                });
                markers = [];

                // Query Firestore
                const q = window.query(window.collection(window.db, "markers"), window.orderBy("timestamp", "desc"));
                const querySnapshot = await window.getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Add marker to map
                    const marker = new longdo.Marker({ lon: data.lon, lat: data.lat }, {
                        title: data.name,
                        detail: data.address || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'
                    });
                    
                    map.Overlays.add(marker);
                    
                    // Add to local array
                    const markerData = {
                        id: doc.id,
                        name: data.name,
                        address: data.address,
                        capacity: data.capacity,
                        lat: data.lat,
                        lon: data.lon,
                        createdAt: data.createdAt ? data.createdAt.toDate().toLocaleString('th-TH') : new Date().toLocaleString('th-TH'),
                        marker: marker
                    };
                    
                    markers.push(markerData);
                });

                updateMarkersList();
                updateStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + markers.length + ' ‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏Å Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

            } catch (error) {
                console.error("Error loading documents: ", error);
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        }

        function updateMarkersList() {
            var markersList = document.getElementById('markersList');
            var markerCount = document.getElementById('markerCount');
            markerCount.textContent = markers.length;

            if (markers.length === 0) {
                markersList.innerHTML = `<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î</p><p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏£‡∏Å!</p></div>`;
                return;
            }

            var html = '';
            markers.forEach(function(markerData, index) {
                html += `
                <div class="marker-item">
                    <div class="marker-header">
                        <div>
                            <div class="marker-name">${markerData.name}</div>
                        </div>
                        <button class="btn-delete" onclick="deleteMarkerFromFirebase('${markerData.id}', ${index})">üóëÔ∏è</button>
                    </div>
                    <div class="marker-details">
                        ${markerData.address ? `üìç ${markerData.address}<br>` : ''}
                        üåç ${markerData.lat.toFixed(6)}, ${markerData.lon.toFixed(6)}<br>
                        üìÖ ${markerData.createdAt}<br>
                        üíæ ID: ${markerData.id}
                    </div>
                    ${markerData.capacity ? `<div class="marker-capacity">üë• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${markerData.capacity.toLocaleString()} ‡∏Ñ‡∏ô</div>` : ''}
                </div>`;
            });

            markersList.innerHTML = html;
        }

        async function deleteMarkerFromFirebase(docId, index) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î "' + markers[index].name + '" ‡∏à‡∏≤‡∏Å Firebase ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    updateStatus('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...');
                    
                    // Delete from Firestore
                    await window.deleteDoc(window.doc(window.db, "markers", docId));
                    
                    // Remove from map
                    map.Overlays.remove(markers[index].marker);
                    
                    // Remove from local array
                    var deletedMarker = markers.splice(index, 1)[0];
                    
                    updateMarkersList();
                    updateStatus('‚úÖ ‡∏•‡∏ö "' + deletedMarker.name + '" ‡∏à‡∏≤‡∏Å Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                }
            }
        }

        function clearAllMarkers() {
            if (markers.length === 0) {
                updateStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏ö');
                return;
            }
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + markers.length + ' ‡∏≠‡∏±‡∏ô ‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ Firebase ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    // Clear from map only (not Firebase)
                    markers.forEach(function(markerData) {
                        map.Overlays.remove(markerData.marker);
                    });
                    markers = [];
                    updateMarkersList();
                    updateStatus('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)');
                } catch (error) {
                    updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î');
                }
            }
        }

        function clearForm() {
            document.getElementById('markerName').value = '';
            document.getElementById('markerAddress').value = '';
            document.getElementById('markerCapacity').value = '';
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        window.onerror = function(msg) {
            updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg);
            return false;
        };
    </script>
</body>
</html>
