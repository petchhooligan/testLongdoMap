<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) */
        .map-section {
            flex: 2;
            position: relative;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220,38,38,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220,38,38,0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° crosshair ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
        .center-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
        }
        
        .crosshair-h {
            width: 30px;
            height: 2px;
            background: #dc2626;
            position: absolute;
            left: -15px;
            top: -1px;
            box-shadow: 0 0 3px rgba(255,255,255,0.8);
        }
        
        .crosshair-v {
            width: 2px;
            height: 30px;
            background: #dc2626;
            position: absolute;
            left: -1px;
            top: -15px;
            box-shadow: 0 0 3px rgba(255,255,255,0.8);
        }
        
        .crosshair-center {
            width: 6px;
            height: 6px;
            background: #dc2626;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            left: -3px;
            top: -3px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ç‡∏ß‡∏≤) */
        .form-section {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
            min-width: 350px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 80px;
            resize: vertical;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
        }
        
        .btn-form {
            width: 100%;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .btn-form:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5,150,105,0.3);
        }
        
        .btn-form:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .coordinate-display {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }
        
        .coordinate-display h4 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .coordinate-text {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .markers-list {
            margin-top: 30px;
        }
        
        .markers-list h3 {
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .marker-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .marker-item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .marker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .marker-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .marker-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .marker-capacity {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #9ca3af;
        }
        
        .empty-state p {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group .form-input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(16px); }
    </style>
    <script type="text/javascript" src="https://api.longdo.com/map3/?key=417740672e7626cdcd09c2756d411dde"></script>
</head>
<body onload="init();">
    <div class="container">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="map-section">
            <div id="map"></div>
            <div class="center-crosshair">
                <div class="crosshair-h"></div>
                <div class="crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            <div class="status" id="status">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database...
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ç‡∏ß‡∏≤) -->
        <div class="form-section">
            <div class="form-group">
                <button type="button" class="btn-form" style="background: linear-gradient(135deg, #dc2626, #ef4444);" onclick="markCenterPosition()">
                    üìç ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                </button>
            </div>

            <form id="markerForm">
                <div class="form-group">
                    <label class="form-label" for="shelterType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á *</label>
                    <select id="shelterType" class="form-input" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                        <option value="‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô">‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
                        <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô">‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="fullName">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                    <input type="text" id="fullName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="phone">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                    <input type="text" id="phone" class="form-input" required pattern="[0-9]{9,10}">
                </div>
                <div class="form-group">
                    <label class="form-label" for="region">‡∏†‡∏≤‡∏Ñ *</label>
                    <select id="region" class="form-input" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
                        <option value="‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                        <option value="‡∏Å‡∏•‡∏≤‡∏á">‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å</option>
                        <option value="‡πÉ‡∏ï‡πâ">‡πÉ‡∏ï‡πâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                    <input type="text" id="province" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="district">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
                    <input type="text" id="district" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="subdistrict">‡∏ï‡∏≥‡∏ö‡∏• *</label>
                    <input type="text" id="subdistrict" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="village">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                    <input type="text" id="village" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label" for="zipcode">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                    <input type="text" id="zipcode" class="form-input" pattern="[0-9]{5}">
                </div>
                <div class="form-group">
                    <label class="form-label" for="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="text" id="place" class="form-input">
                </div>
                <!-- ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å -->
                <div class="form-group input-group">
                    <div style="flex:1;">
                        <label class="form-label">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label>
                        <input type="text" id="lat" class="form-input" value="" readonly>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label>
                        <input type="text" id="lon" class="form-input" value="" readonly>
                    </div>
                </div>
                <div class="form-group input-group">
                    <div style="flex:1;">
                        <label class="form-label" for="electricity">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                        <select id="electricity" class="form-input">
                            <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" selected>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label" for="water">‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</label>
                        <select id="water" class="form-input">
                            <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" selected>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label" for="wifi">Wifi</label>
                        <select id="wifi" class="form-input">
                            <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" selected>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group input-group">
                    <div style="flex:1;">
                        <label class="form-label" for="pet">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label>
                        <select id="pet" class="form-input">
                            <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" selected>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label" for="tent">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</label>
                        <select id="tent" class="form-input">
                            <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                            <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" selected>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label" for="toilet">‡∏™‡∏∏‡∏Ç‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                        <input type="text" id="toilet" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏≤">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="parking">‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                    <input type="text" id="parking" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ">
                </div>
                <div class="form-group">
                    <label class="form-label" for="canSupport">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                    <input type="number" id="canSupport" class="form-input" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="currentSupport">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                    <input type="number" id="currentSupport" class="form-input" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                    <select id="status" class="form-input" required>
                        <option value="‡πÄ‡∏õ‡∏¥‡∏î">‡πÄ‡∏õ‡∏¥‡∏î</option>
                        <option value="‡∏õ‡∏¥‡∏î" selected>‡∏õ‡∏¥‡∏î</option>
                    </select>
                </div>
                <button type="submit" class="btn-form" id="addMarkerBtn">
                    ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </form>

            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="loadMarkersFromFirebase()">
                    üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Database
                </button>
                <button type="button" class="btn-secondary" onclick="clearAllMarkers()">
                    üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>

            <div class="markers-list">
                <h3>üìå ‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="markerCount">0</span>)</h3>
                <div id="markersList">
                    <div class="empty-state">
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î</p>
                        <p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏£‡∏Å!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRCO-wzB0sKIjGXw_IPJGSnjcw00ZBGME",
            authDomain: "testlongdomap.firebaseapp.com",
            projectId: "testlongdomap",
            storageBucket: "testlongdomap.firebasestorage.app",
            messagingSenderId: "391627017137",
            appId: "1:391627017137:web:8221c2540c136bccaf0b90",
            measurementId: "G-BE75QETT05"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.updateDoc = updateDoc;

        window.addEventListener('load', function() {
            setTimeout(function() {
                updateStatus('‚úÖ Database ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î');
                loadMarkersFromFirebase();
            }, 1000);
        });
    </script>

    <script>
        var map;
        var markers = [];
        var currentLat = 13.736717;
        var currentLon = 100.523186;
        var selectedLat = null;
        var selectedLon = null;

        function init() {
            try {
                if (typeof longdo === 'undefined') {
                    setTimeout(init, 500);
                    return;
                }

                map = new longdo.Map({
                    placeholder: document.getElementById('map'),
                    language: 'th'
                });

                map.location({ lon: currentLon, lat: currentLat });
                map.zoom(6);

                map.Event.bind('moveend', updateCurrentCoordinate);
                updateCurrentCoordinate();
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...');
            } catch (error) {
                updateStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ' + error.message);
            }
        }

        function updateCurrentCoordinate() {
            try {
                var centerLocation = map.location();
                if (centerLocation) {
                    currentLat = centerLocation.lat;
                    currentLon = centerLocation.lon;
                    var coordElem = document.getElementById('currentCoordinate');
                    if (coordElem) {
                        coordElem.innerHTML =
                            '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ' + currentLat.toFixed(6) + '<br>' +
                            '‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: ' + currentLon.toFixed(6);
                    }
                }
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }

        function markCenterPosition() {
            try {
                var center = map.location();
                currentLat = center.lat;
                currentLon = center.lon;
                updateCurrentCoordinate();
                updateStatus('üìç ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"');
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á input lat/lon
                document.getElementById('lat').value = currentLat;
                document.getElementById('lon').value = currentLon;
            } catch (error) {
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        document.getElementById('markerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addMarkerWithData();
        });

        function createMarker(lat, lon, name, address, active, capacity, markerId, markerIndex, extraData = {}) {
            let detail = '';
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            if (extraData.shelterType) detail += `üè¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå: ${extraData.shelterType}<br>`;
            if (name) detail += `üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: ${name}<br>`;
            if (extraData.phone) detail += `üìû ‡πÇ‡∏ó‡∏£: ${extraData.phone}<br>`;
            if (extraData.region) detail += `üó∫Ô∏è ‡∏†‡∏≤‡∏Ñ: ${extraData.region}<br>`;
            if (extraData.province) detail += `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${extraData.province}<br>`;
            if (extraData.district) detail += `‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: ${extraData.district}<br>`;
            if (extraData.subdistrict) detail += `‡∏ï‡∏≥‡∏ö‡∏•: ${extraData.subdistrict}<br>`;
            if (extraData.village) detail += `‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô: ${extraData.village}<br>`;
            if (extraData.zipcode) detail += `‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${extraData.zipcode}<br>`;
            if (address) detail += `üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${address}<br>`;
            detail += `üåç ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>`;
            if (capacity) detail += `üë• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ${capacity.toLocaleString()} ‡∏Ñ‡∏ô<br>`;
            if (extraData.currentSupport) detail += `üë§ ‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á: ${extraData.currentSupport} ‡∏Ñ‡∏ô<br>`;
            if (extraData.parking) detail += `üöó ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ: ${extraData.parking} ‡∏Ñ‡∏±‡∏ô<br>`;
            if (extraData.electricity) detail += `‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤<br>`;
            if (extraData.water) detail += `üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤<br>`;
            if (extraData.toilet) detail += `üöª ‡∏™‡∏∏‡∏Ç‡∏≤<br>`;
            if (extraData.wifi) detail += `üì∂ Wifi<br>`;
            if (extraData.pet) detail += `üêæ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á<br>`;
            if (extraData.tent) detail += `‚õ∫ ‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå<br>`;
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° toggle ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
            if (typeof markerId !== 'undefined' && typeof markerIndex !== 'undefined') {
                detail += `
                    <div style='margin:8px 0;'>
                        <label class="switch">
                            <input type="checkbox" ${active ? 'checked' : ''} onchange="toggleActive('${markerId}', ${markerIndex}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style='margin-left:8px;'>${active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}</span>
                    </div>
                `;
                detail += `
                    <button onclick="editMarkerFromPopup('${markerId}', ${markerIndex})" style="margin-top:8px;margin-right:8px;background:#3b82f6;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="deleteMarkerFromPopup('${markerId}', ${markerIndex})" style="margin-top:8px;background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>
                `;
            }
            const markerOptions = {
                title: name,
                detail: detail
            };
            if (active) {
                markerOptions.icon = {
                    url: 'greenMarker.png',
                    offset: { x: 0, y: -18 },
                    size: { w: 32, h: 32 }
                };
            }
            const marker = new longdo.Marker(
                { lon: lon, lat: lat },
                markerOptions
            );
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event hover ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á/‡∏õ‡∏¥‡∏î‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ Event ‡∏Å‡πà‡∏≠‡∏ô)
            if (marker && marker.Event && typeof marker.Event.bind === 'function') {
                marker.Event.bind('mouseover', function() {
                    map.InfoWindow.open(marker);
                });
                marker.Event.bind('mouseout', function() {
                    map.InfoWindow.close();
                });
            }
            return marker;
        }

        async function addMarkerWithData() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                var shelterType = document.getElementById('shelterType').value;
                if (!["‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô", "‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].includes(shelterType)) shelterType = '';
                var name = document.getElementById('fullName').value.trim();
                var phone = document.getElementById('phone').value.trim();
                var region = document.getElementById('region').value;
                var province = document.getElementById('province').value.trim();
                var district = document.getElementById('district').value.trim();
                var subdistrict = document.getElementById('subdistrict').value.trim();
                var village = document.getElementById('village').value.trim();
                var zipcode = document.getElementById('zipcode').value.trim();
                var place = document.getElementById('place').value.trim();
                var lat = document.getElementById('lat').value;
                var lon = document.getElementById('lon').value;
                var electricity = document.getElementById('electricity').value;
                var water = document.getElementById('water').value;
                var wifi = document.getElementById('wifi').value;
                var pet = document.getElementById('pet').value;
                var tent = document.getElementById('tent').value;
                var toilet = document.getElementById('toilet').value.trim();
                var parking = document.getElementById('parking').value.trim();
                var canSupport = document.getElementById('canSupport').value;
                var currentSupport = document.getElementById('currentSupport').value;
                var status = document.getElementById('status').value;
                if (!status) status = '‡πÄ‡∏õ‡∏¥‡∏î';
                var active = (status === '‡πÄ‡∏õ‡∏¥‡∏î');

                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
                    return;
                }

                var addBtn = document.getElementById('addMarkerBtn');
                var originalText = addBtn.textContent;
                addBtn.textContent = 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                addBtn.disabled = true;

                var markerData = {
                    shelterType: shelterType || '',
                    name: name,
                    phone: phone || '',
                    region: region || '',
                    province: province || '',
                    district: district || '',
                    subdistrict: subdistrict || '',
                    village: village || '',
                    zipcode: zipcode || '',
                    address: place || '',
                    lat: lat ? parseFloat(lat) : currentLat,
                    lon: lon ? parseFloat(lon) : currentLon,
                    electricity: electricity || '',
                    water: water || '',
                    wifi: wifi || '',
                    pet: pet || '',
                    tent: tent || '',
                    toilet: toilet || '',
                    parking: parking || '',
                    capacity: canSupport ? parseInt(canSupport) : null,
                    currentSupport: currentSupport ? parseInt(currentSupport) : null,
                    active: active,
                    createdAt: new Date(),
                    timestamp: Date.now(),
                };

                // Save to Firebase Firestore
                const docRef = await window.addDoc(window.collection(window.db, "markers"), markerData);

                // Add marker to map
                var marker = createMarker(markerData.lat, markerData.lon, name, place, false, markerData.capacity, markerData.id, markers.length, markerData);

                map.Overlays.add(marker);

                markerData.id = docRef.id;
                markerData.marker = marker;
                markerData.createdAt = markerData.createdAt.toLocaleString('th-TH');
                markers.push(markerData);

                updateMarkersList();
                clearForm();
                updateStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "' + name + '" ‡πÉ‡∏ô Database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

                addBtn.textContent = originalText;
                addBtn.disabled = false;

            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
                var addBtn = document.getElementById('addMarkerBtn');
                addBtn.textContent = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                addBtn.disabled = false;
            }
        }

        async function loadMarkersFromFirebase() {
            try {
                updateStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Database...');
                markers.forEach(function(markerData) {
                    if (markerData.marker) {
                        map.Overlays.remove(markerData.marker);
                    }
                });
                markers = [];

                const q = window.query(window.collection(window.db, "markers"), window.orderBy("timestamp", "desc"));
                const querySnapshot = await window.getDocs(q);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const marker = createMarker(
                        data.lat,
                        data.lon,
                        data.name,
                        data.address,
                        data.active,
                        data.capacity,
                        doc.id,
                        markers.length, // index ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        data // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    );
                    map.Overlays.add(marker);

                    const markerData = {
                        ...data,
                        id: doc.id,
                        marker: marker,
                        createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString('th-TH') : new Date().toLocaleString('th-TH'),
                        active: data.active === true
                    };
                    markerData.status = markerData.active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
                    markers.push(markerData);
                });

                updateMarkersList();
                updateStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + markers.length + ' ‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏Å Database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô card ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
        function updateMarkersList() {
            var markersList = document.getElementById('markersList');
            var markerCount = document.getElementById('markerCount');
            markerCount.textContent = markers.length;

            if (markers.length === 0) {
                markersList.innerHTML = `<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î</p><p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏£‡∏Å!</p></div>`;
                return;
            }

            var html = '';
            markers.forEach(function(markerData, index) {
                html += `
                <div class="marker-item">
                    <div class="marker-header">
                        <div>
                            <div class="marker-name">${markerData.name}</div>
                        </div>
                        <div style="display:flex;gap:6px;">
                            <button class="btn-delete" onclick="editMarkerFromCard('${markerData.id}', ${index})" style="background:#3b82f6;">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deleteMarkerFromFirebase('${markerData.id}', ${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                        <label class="switch">
                            <input type="checkbox" ${markerData.active ? 'checked' : ''} onchange="toggleActive('${markerData.id}', ${index}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span>${markerData.active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}</span>
                    </div>
                    <div class="marker-details">
                        ${markerData.address ? `üìç ${markerData.address}<br>` : ''}
                        üåç ${markerData.lat.toFixed(6)}, ${markerData.lon.toFixed(6)}<br>
                        üìÖ ${markerData.createdAt}<br>
                        üíæ ID: ${markerData.id}
                    </div>
                    ${markerData.capacity ? `<div class="marker-capacity">üë• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${markerData.capacity.toLocaleString()} ‡∏Ñ‡∏ô</div>` : ''}
                    ${markerData.parking ? `<div class="marker-capacity">üöó ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ ${markerData.parking.toLocaleString()} ‡∏Ñ‡∏±‡∏ô</div>` : ''}
                </div>`;
            });

            markersList.innerHTML = html;
        }

        async function toggleActive(id, index, isActive) {
    try {
        const markerRef = window.doc(window.collection(window.db, "markers"), id);
        await window.updateDoc(markerRef, {
            active: isActive
        });

        markers[index].active = isActive;
        markers[index].status = isActive ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';

        // ‡∏£‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤ active
        if (markers[index].marker) {
            map.Overlays.remove(markers[index].marker);
        }
        const newMarker = createMarker(
            markers[index].lat,
            markers[index].lon,
            markers[index].name,
            markers[index].address,
            isActive,
            markers[index].capacity,
            markers[index].id,
            index,
            markers[index] // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå
        );
        map.Overlays.add(newMarker);
        markers[index].marker = newMarker;

        updateMarkersList();
        updateStatus(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "${markers[index].name}" ‡πÄ‡∏õ‡πá‡∏ô ${isActive ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`);
    } catch (error) {
        console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï active:', error);
        updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ active ‡πÑ‡∏î‡πâ');
    }
}


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÉ‡∏ä‡πâ window.prompt ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
        function editMarkerFromPopup(id, index) {
            openEditMarkerModal(id, index);
            if (map && map.InfoWindow && typeof map.InfoWindow.close === 'function') {
                map.InfoWindow.close();
            }
        }
        function editMarkerFromCard(id, index) {
            openEditMarkerModal(id, index);
        }

        // Modal HTML
        function createEditModalHTML(marker, index) {
            return `
            <div id="editMarkerModalBg" style="position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;">
                <div style="background:#fff;padding:32px 24px;border-radius:16px;min-width:350px;max-width:600px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;overflow-y:auto;max-height:90vh;">
                    <h2 style="font-size:20px;font-weight:700;margin-bottom:18px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î</h2>
                    <form id="editMarkerForm">
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á *</label>
                            <select id="editShelterType" class="form-input" required>
                                <option value="‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô" ${marker.shelterType === '‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô' ? 'selected' : ''}>‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô" ${marker.shelterType === '‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô' ? 'selected' : ''}>‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ${marker.shelterType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'selected' : ''}>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="editName" value="${marker.name || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                            <input type="text" id="editPhone" value="${marker.phone || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏†‡∏≤‡∏Ñ *</label>
                            <input type="text" id="editRegion" value="${marker.region || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                            <input type="text" id="editProvince" value="${marker.province || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
                            <input type="text" id="editDistrict" value="${marker.district || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏ï‡∏≥‡∏ö‡∏• *</label>
                            <input type="text" id="editSubdistrict" value="${marker.subdistrict || ''}" required style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                            <input type="text" id="editVillage" value="${marker.village || ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                            <input type="text" id="editZipcode" value="${marker.zipcode || ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="editPlace" value="${marker.address || ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ</label>
                            <input type="number" id="editCapacity" min="1" value="${marker.capacity ? marker.capacity : ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á</label>
                            <input type="number" id="editCurrentSupport" min="0" value="${marker.currentSupport ? marker.currentSupport : ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ</label>
                            <input type="text" id="editParking" value="${marker.parking || ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏™‡∏∏‡∏Ç‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                            <input type="text" id="editToilet" value="${marker.toilet || ''}" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;">
                        </div>
                        <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;">
                            <div style="flex:1;min-width:120px;">
                                <label style="font-weight:600;">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                                <select id="editElectricity" class="form-input">
                                    <option value="‡∏°‡∏µ" ${marker.electricity === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" ${marker.electricity === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:120px;">
                                <label style="font-weight:600;">‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</label>
                                <select id="editWater" class="form-input">
                                    <option value="‡∏°‡∏µ" ${marker.water === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" ${marker.water === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:120px;">
                                <label style="font-weight:600;">Wifi</label>
                                <select id="editWifi" class="form-input">
                                    <option value="‡∏°‡∏µ" ${marker.wifi === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" ${marker.wifi === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:120px;">
                                <label style="font-weight:600;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label>
                                <select id="editPet" class="form-input">
                                    <option value="‡∏°‡∏µ" ${marker.pet === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" ${marker.pet === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:120px;">
                                <label style="font-weight:600;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</label>
                                <select id="editTent" class="form-input">
                                    <option value="‡∏°‡∏µ" ${marker.tent === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ" ${marker.tent === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                            <select id="editStatus" style="width:100%;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;" onchange="window.syncEditStatusWithActive && window.syncEditStatusWithActive(this.value)">
                                <option value="‡πÄ‡∏õ‡∏¥‡∏î" ${marker.active ? 'selected' : ''}>‡πÄ‡∏õ‡∏¥‡∏î</option>
                                <option value="‡∏õ‡∏¥‡∏î" ${!marker.active ? 'selected' : ''}>‡∏õ‡∏¥‡∏î</option>
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</label>
                            <div style="display:flex;gap:8px;margin-bottom:8px;">
                                <input type="number" id="editLat" step="any" value="${marker.lat}" required style="flex:1;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î">
                                <input type="number" id="editLon" step="any" value="${marker.lon}" required style="flex:1;padding:8px 12px;border-radius:6px;border:1.5px solid #e5e7eb;" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î">
                            </div>
                            <button type="button" id="btnSelectNewPosition" style="background:#f59e42;color:#fff;padding:8px 12px;border:none;border-radius:6px;font-weight:600;cursor:pointer;">üìç ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                            <span id="selectingPositionHint" style="display:none;color:#f59e42;font-size:13px;margin-left:8px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà...</span>
                        </div>
                        <div style="margin-bottom:16px;">
                            <div style="width:100%;height:220px;position:relative;border-radius:10px;overflow:hidden;border:1.5px solid #e5e7eb;">
                                <div id="editMap" style="width:100%;height:100%;"></div>
                                <div class="center-crosshair" style="pointer-events:none;">
                                    <div class="crosshair-h"></div>
                                    <div class="crosshair-v"></div>
                                    <div class="crosshair-center"></div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;margin-top:18px;">
                            <button type="submit" style="flex:1;background:#059669;color:#fff;padding:10px 0;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button type="button" onclick="closeEditMarkerModal()" style="flex:1;background:#e5e7eb;color:#374151;padding:10px 0;border:none;border-radius:8px;font-weight:600;font-size:16px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </form>
                    <button onclick="closeEditMarkerModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:22px;cursor:pointer;color:#9ca3af;">√ó</button>
                </div>
            </div>
            `;
        }

        // ‡∏õ‡∏£‡∏±‡∏ö openEditMarkerModal ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        function openEditMarkerModal(id, index) {
            editingMarkerIndex = index;
            editingMarkerModalDiv = document.createElement('div');
            editingMarkerModalDiv.innerHTML = createEditModalHTML(markers[index], index);
            document.body.appendChild(editingMarkerModalDiv);

            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏±‡∏ö active ‡πÉ‡∏ô modal
            window.syncEditStatusWithActive = function(val) {
                markers[index].active = (val === '‡πÄ‡∏õ‡∏¥‡∏î');
                markers[index].status = markers[index].active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
            };
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ sync ‡∏Ñ‡πà‡∏≤ status ‡∏Å‡∏±‡∏ö active ‡∏î‡πâ‡∏ß‡∏¢
            var statusSel = document.getElementById('editStatus');
            if (statusSel) {
                statusSel.value = markers[index].active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';
            }

            setTimeout(function() {
                let editLatInput = document.getElementById('editLat');
                let editLonInput = document.getElementById('editLon');
                // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                var m = markers[index];
                var setVal = (id, val) => { var el = document.getElementById(id); if (el) el.value = val ?? ''; };
                setVal('editShelterType', m.shelterType);
                setVal('editName', m.name);
                setVal('editPhone', m.phone);
                setVal('editRegion', m.region);
                setVal('editProvince', m.province);
                setVal('editDistrict', m.district);
                setVal('editSubdistrict', m.subdistrict);
                setVal('editVillage', m.village);
                setVal('editZipcode', m.zipcode);
                setVal('editPlace', m.address);
                setVal('editCapacity', m.capacity);
                setVal('editCurrentSupport', m.currentSupport);
                setVal('editParking', m.parking);
                setVal('editToilet', m.toilet);
                setVal('editElectricity', m.electricity);
                setVal('editWater', m.water);
                setVal('editWifi', m.wifi);
                setVal('editPet', m.pet);
                setVal('editTent', m.tent);
                setVal('editStatus', m.active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î');
                setVal('editLat', m.lat);
                setVal('editLon', m.lon);

                window.editMapObj = new longdo.Map({
                    placeholder: document.getElementById('editMap'),
                    language: 'th'
                });
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                window.editMapObj.location({ lat: lat, lon: lon });
                window.editMapObj.zoom(16);
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö set location ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á zoom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
                setTimeout(function() {
                    window.editMapObj.location({ lat: lat, lon: lon });
                }, 200);

                window.editMapObj.Event.bind('moveend', function() {
                    if (window.isSelectingNewPosition) {
                        const c = window.editMapObj.location();
                        document.getElementById('editLat').value = c.lat;
                        document.getElementById('editLon').value = c.lon;
                    }
                });

                editLatInput.addEventListener('input', function() {
                    if (!window.isSelectingNewPosition) {
                        let lat = parseFloat(editLatInput.value);
                        let lon = parseFloat(editLonInput.value);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            window.editMapObj.location({ lat: lat, lon: lon });
                        }
                    }
                });
                editLonInput.addEventListener('input', function() {
                    if (!window.isSelectingNewPosition) {
                        let lat = parseFloat(editLatInput.value);
                        let lon = parseFloat(editLonInput.value);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            window.editMapObj.location({ lat: lat, lon: lon });
                        }
                    }
                });
            }, 100);

            // handle submit
            document.getElementById('editMarkerForm').onsubmit = async function(e) {
                e.preventDefault();
                if (window.isSelectingNewPosition) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô');
                    return;
                }
                const newShelterType = document.getElementById('editShelterType').value.trim();
                const newName = document.getElementById('editName').value.trim();
                const newPhone = document.getElementById('editPhone').value.trim();
                const newRegion = document.getElementById('editRegion').value.trim();
                const newProvince = document.getElementById('editProvince').value.trim();
                const newDistrict = document.getElementById('editDistrict').value.trim();
                const newSubdistrict = document.getElementById('editSubdistrict').value.trim();
                const newVillage = document.getElementById('editVillage').value.trim();
                const newZipcode = document.getElementById('editZipcode').value.trim();
                const newAddress = document.getElementById('editPlace').value.trim();
                const newCapacity = document.getElementById('editCapacity').value;
                const newCurrentSupport = document.getElementById('editCurrentSupport').value;
                const newParking = document.getElementById('editParking').value;
                const newElectricity = document.getElementById('editElectricity').value;
                const newWater = document.getElementById('editWater').value;
                const newToilet = document.getElementById('editToilet').value;
                const newWifi = document.getElementById('editWifi').value;
                const newPet = document.getElementById('editPet').value;
                const newTent = document.getElementById('editTent').value;
                const newStatus = document.getElementById('editStatus').value;
                const newActive = (newStatus === '‡πÄ‡∏õ‡∏¥‡∏î');
                const newLat = parseFloat(document.getElementById('editLat').value);
                const newLon = parseFloat(document.getElementById('editLon').value);

                if (!newName || isNaN(newLat) || isNaN(newLon)) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }

                try {
                    await window.updateDoc(window.doc(window.db, "markers", id), {
                        shelterType: newShelterType,
                        name: newName,
                        phone: newPhone,
                        region: newRegion,
                        province: newProvince,
                        district: newDistrict,
                        subdistrict: newSubdistrict,
                        village: newVillage,
                        zipcode: newZipcode,
                        address: newAddress,
                        capacity: newCapacity ? parseInt(newCapacity) : null,
                        currentSupport: newCurrentSupport ? parseInt(newCurrentSupport) : null,
                        parking: newParking ? parseInt(newParking) : null,
                        electricity: newElectricity,
                        water: newWater,
                        toilet: newToilet,
                        wifi: newWifi,
                        pet: newPet,
                        tent: newTent,
                        active: newActive,
                        lat: newLat,
                        lon: newLon
                    });

                    markers[index].active = newActive;
                    markers[index].status = newActive ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';

                    map.Overlays.remove(markers[index].marker);
                    markers[index].marker = createMarker(
                        newLat,
                        newLon,
                        newName,
                        newAddress,
                        markers[index].active,
                        markers[index].capacity,
                        id,
                        index,
                        markers[index] // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    );
                    map.Overlays.add(markers[index].marker);

                    updateMarkersList();
                    updateStatus('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeEditMarkerModal();
                } catch (err) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + err.message);
                }
            };

            // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
            document.getElementById('btnSelectNewPosition').onclick = function() {
                window.isSelectingNewPosition = true;
                document.getElementById('btnSelectNewPosition').disabled = true;
                document.getElementById('selectingPositionHint').style.display = '';
                updateStatus('üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ"');

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ" ‡πÉ‡∏ï‡πâ crosshair ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢
                if (!document.getElementById('editMapSelectBtn')) {
                    const btn = document.createElement('button');
                    btn.id = 'editMapSelectBtn';
                    btn.textContent = '‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ';
                    btn.style = 'position:absolute;top:calc(50% + 40px);left:50%;transform:translateX(-50%);z-index:1001;background:#059669;color:#fff;padding:10px 18px;border:none;border-radius:8px;font-size:16px;font-weight:600;box-shadow:0 2px 8px rgba(5,150,105,0.18);cursor:pointer;';
                    btn.onclick = function() {
                        // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏á input ‡∏Ç‡∏≠‡∏á modal edit ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        const center = window.editMapObj.location();
                        const editLatInput = document.getElementById('editLat');
                        const editLonInput = document.getElementById('editLon');
                        if (editLatInput && editLonInput) {
                            editLatInput.value = center.lat;
                            editLonInput.value = center.lon;
                            updateStatus('üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
                        }
                        // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        window.isSelectingNewPosition = false;
                        document.getElementById('btnSelectNewPosition').disabled = false;
                        document.getElementById('selectingPositionHint').style.display = 'none';
                        btn.remove();
                    };
                    document.getElementById('editMap').parentNode.appendChild(btn);
                }
            };
        }

        function clearForm() {
            document.getElementById('fullName').value = '';
            document.getElementById('place').value = '';
            document.getElementById('canSupport').value = '';
            document.getElementById('parking').value = '';
        }

        function updateStatus(message) {
            var statusElem = document.getElementById('status');
            statusElem.innerHTML = message;
            statusElem.style.opacity = 1;
            statusElem.style.transition = 'opacity 0.5s';
            if (window._statusTimeout) clearTimeout(window._statusTimeout);
            window._statusTimeout = setTimeout(function() {
                statusElem.style.opacity = 0;
            }, 5000);
        }

        function deleteMarkerFromPopup(id, index) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                deleteMarkerFromFirebase(id, index);
                // ‡∏õ‡∏¥‡∏î‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û
                map.InfoWindow.close();
            }
        }

        window.onerror = function(msg) {
            updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg);
            return false;
        };

        function closeEditMarkerModal() {
            const modal = document.getElementById('editMarkerModalBg');
            if (modal) modal.parentNode.removeChild(modal);
        }
    </script>
</body>
</html>
