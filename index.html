<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡πâ‡∏≤‡∏¢) */
        .map-section {
            flex: 2;
            position: relative;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° crosshair ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ */
        .center-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
        }

        .crosshair-h {
            width: 30px;
            height: 2px;
            background: #dc2626;
            position: absolute;
            left: -15px;
            top: -1px;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .crosshair-v {
            width: 2px;
            height: 30px;
            background: #dc2626;
            position: absolute;
            left: -1px;
            top: -15px;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .crosshair-center {
            width: 6px;
            height: 6px;
            background: #dc2626;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            left: -3px;
            top: -3px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 300px;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ç‡∏ß‡∏≤) */
        .form-section {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
            min-width: 350px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 80px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .btn-form {
            width: 100%;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-form:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-form:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .coordinate-display {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }

        .coordinate-display h4 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .coordinate-text {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .markers-list {
            margin-top: 30px;
        }

        .markers-list h3 {
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .marker-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .marker-item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .marker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .marker-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .marker-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .marker-capacity {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #9ca3af;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group button {
            flex: 1;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
            vertical-align: middle;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #10b981;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .edit-modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .edit-modal-header {
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
        }

        .edit-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 18px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-modal-close:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .edit-grid {
            display: block;
            margin-top: 20px;
        }

        .edit-form-section {
            overflow-y: auto;
            max-height: 80vh;
            padding-right: 10px;
        }

        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .edit-map-container {
            width: 100%;
            height: 300px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .edit-map {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .edit-modal-content {
                width: 98%;
                margin: 10px;
            }

            .edit-map-container {
                height: 250px;
            }
        }

        .capacity-bar-container {
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            height: 16px;
            margin-top: 10px;
        }

        .capacity-bar {
            height: 100%;
            transition: width 0.5s ease;
        }
    </style>
    <script type="text/javascript" src="https://api.longdo.com/map3/?key=417740672e7626cdcd09c2756d411dde"></script>
</head>

<body onload="init();">
    <!-- ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° login ‡∏´‡∏£‡∏∑‡∏≠ username/logout -->
    <div id="userPanel" style="position: fixed; top: 20px; right: 20px; z-index: 3000;"></div>

    <div class="container">
        <div class="map-section">
            <div id="map"></div>
            <div class="center-crosshair">
                <div class="crosshair-h"></div>
                <div class="crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            <div class="status" id="status">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database...
            </div>
        </div>

        <div class="form-section">
            <div class="form-group" style="display:flex; flex-wrap:wrap; gap:10px;">
                <button type="button" class="btn-form"
                    style="width: 100%; background: linear-gradient(135deg, #3b82f6, #60a5fa);"
                    onclick="openCreateModal()">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
                <button type="button" class="btn-form"
                    style="background: linear-gradient(135deg, #f59e42, #fbbf24); flex:1;" onclick="drawAllRadii()">
                    ‚≠ï ‡∏î‡∏π‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button type="button" class="btn-form"
                    style="background: linear-gradient(135deg, #6b7280, #9ca3af); flex:1;" onclick="clearAllRadii()">
                    üö´ ‡∏•‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>

            <!-- üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏°‡∏∏‡∏î -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á</label>
                <div class="input-group">
                    <select id="filter_status" class="form-input">
                        <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="‡πÄ‡∏õ‡∏¥‡∏î">‡πÄ‡∏õ‡∏¥‡∏î</option>
                        <option value="‡∏õ‡∏¥‡∏î">‡∏õ‡∏¥‡∏î</option>
                    </select>
                    <select id="filter_type" class="form-input">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                        <option value="‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô">‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
                        <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô">‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                    <select id="filter_region" class="form-input">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏Ñ</option>
                        <option value="‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                        <option value="‡∏Å‡∏•‡∏≤‡∏á">‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</option>
                        <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å</option>
                        <option value="‡πÉ‡∏ï‡πâ">‡πÉ‡∏ï‡πâ</option>
                    </select>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <input type="text" id="filter_province" class="form-input" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
                    <input type="text" id="filter_district" class="form-input" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠">
                    <input type="text" id="filter_subdistrict" class="form-input" placeholder="‡∏ï‡∏≥‡∏ö‡∏•">
                </div>
                <div class="btn-group" style="margin-top: 10px;">
                    <button class="btn-secondary" onclick="applyFilter()">üîç ‡∏Å‡∏£‡∏≠‡∏á</button>
                    <button class="btn-secondary" onclick="clearFilter()">‚ùå ‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
            </div>


            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="loadMarkersFromFirebase()">
                    üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Database
                </button>
            </div>

            <div class="markers-list">
                <h3>üìå ‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="markerCount">0</span>)</h3>
                <div id="markersList">
                    <div class="empty-state">
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î</p>
                        <p>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏£‡∏Å!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 class="edit-modal-header">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á</h2>
            <button onclick="closeEditModal()" class="edit-modal-close">‚úï</button>

            <div class="edit-grid">
                <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
                <div class="edit-form-section">
                    <form id="editMarkerForm">
                        <div class="form-group">
                            <label class="form-label" for="edit_shelterType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á *</label>
                            <select id="edit_shelterType" class="form-input" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                                <option value="‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô">‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô">‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_fullName">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="edit_fullName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_phone">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                            <input type="text" id="edit_phone" class="form-input" required pattern="[0-9]{9,10}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_region">‡∏†‡∏≤‡∏Ñ *</label>
                            <select id="edit_region" class="form-input" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
                                <option value="‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                                <option value="‡∏Å‡∏•‡∏≤‡∏á">‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å</option>
                                <option value="‡πÉ‡∏ï‡πâ">‡πÉ‡∏ï‡πâ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                            <input type="text" id="edit_province" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_district">‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
                            <input type="text" id="edit_district" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_subdistrict">‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏• *</label>
                            <input type="text" id="edit_subdistrict" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_village">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                            <input type="text" id="edit_village" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_zipcode">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                            <input type="text" id="edit_zipcode" class="form-input" pattern="[0-9]{5}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="edit_place" class="form-input">
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label>
                                <input type="text" id="edit_lat" class="form-input" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î">
                            </div>
                            <div style="flex:1;">
                                <label class="form-label">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label>
                                <input type="text" id="edit_lon" class="form-input" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î">
                            </div>
                        </div>

                        <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà -->
                        <div class="form-group">
                            <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</label>
                            <div id="editMapContainer" class="edit-map-container">
                                <div id="editMap" class="edit-map"></div>
                            </div>
                        </div>

                        <button type="button" class="btn-form"
                            style="margin-top:10px;background:linear-gradient(135deg,#dc2626,#ef4444);"
                            onclick="selectCurrentLocation()">
                            üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                        </button>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="edit_electricity">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                                <select id="edit_electricity" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_water">‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</label>
                                <select id="edit_water" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_wifi">Wifi</label>
                                <select id="edit_wifi" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="edit_pet">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label>
                                <select id="edit_pet" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_tent">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</label>
                                <select id="edit_tent" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_toilet">‡∏™‡∏∏‡∏Ç‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                                <input type="text" id="edit_toilet" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏≤">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_parking">‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                            <input type="text" id="edit_parking" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_canSupport">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                            <input type="number" id="edit_canSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_currentSupport">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                            <input type="number" id="edit_currentSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                            <select id="edit_status" class="form-input" required>
                                <option value="‡πÄ‡∏õ‡∏¥‡∏î">‡πÄ‡∏õ‡∏¥‡∏î</option>
                                <option value="‡∏õ‡∏¥‡∏î">‡∏õ‡∏¥‡∏î</option>
                            </select>
                        </div>

                        <button type="submit" class="btn-form"
                            style="margin-top:20px; background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà -->
    <div id="createModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 class="edit-modal-header">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
            <button onclick="closeCreateModal()" class="edit-modal-close">‚úï</button>
            <div class="edit-grid">
                <div class="edit-form-section">
                    <form id="createMarkerForm" onsubmit="event.preventDefault(); addMarkerWithData();">
                        <!-- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å editModal ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô id ‡πÄ‡∏õ‡πá‡∏ô create_ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                        <div class="form-group">
                            <label class="form-label" for="create_shelterType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á *</label>
                            <select id="create_shelterType" class="form-input" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                                <option value="‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô">‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô">‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_fullName">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="create_fullName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_phone">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                            <input type="text" id="create_phone" class="form-input" required pattern="[0-9]{9,10}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_region">‡∏†‡∏≤‡∏Ñ *</label>
                            <select id="create_region" class="form-input" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
                                <option value="‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                                <option value="‡∏Å‡∏•‡∏≤‡∏á">‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</option>
                                <option value="‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å">‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å</option>
                                <option value="‡πÉ‡∏ï‡πâ">‡πÉ‡∏ï‡πâ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
                            <input type="text" id="create_province" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_district">‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
                            <input type="text" id="create_district" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_subdistrict">‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏• *</label>
                            <input type="text" id="create_subdistrict" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_village">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                            <input type="text" id="create_village" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_zipcode">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                            <input type="text" id="create_zipcode" class="form-input" pattern="[0-9]{5}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="create_place" class="form-input">
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label>
                                <input type="text" id="create_lat" class="form-input">
                            </div>
                            <div style="flex:1;">
                                <label class="form-label">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label>
                                <input type="text" id="create_lon" class="form-input">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <div id="createMapContainer" class="edit-map-container">
                                <div id="createMap" class="edit-map"></div>
                            </div>
                        </div>

                        <button type="button" class="btn-form"
                            style="margin-top:10px;background:linear-gradient(135deg,#dc2626,#ef4444);"
                            onclick="selectCurrentLocationCreate()">
                            üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                        </button>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="create_electricity">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</label>
                                <select id="create_electricity" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="create_water">‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</label>
                                <select id="create_water" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="create_wifi">Wifi</label>
                                <select id="create_wifi" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="create_pet">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label>
                                <select id="create_pet" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="create_tent">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</label>
                                <select id="create_tent" class="form-input">
                                    <option value="‡∏°‡∏µ">‡∏°‡∏µ</option>
                                    <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="create_toilet">‡∏™‡∏∏‡∏Ç‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                                <input type="text" id="create_toilet" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏≤">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_parking">‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label>
                            <input type="text" id="create_parking" class="form-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_canSupport">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                            <input type="number" id="create_canSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_currentSupport">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                            <input type="number" id="create_currentSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="create_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                            <select id="create_status" class="form-input" required>
                                <option value="‡πÄ‡∏õ‡∏¥‡∏î">‡πÄ‡∏õ‡∏¥‡∏î</option>
                                <option value="‡∏õ‡∏¥‡∏î">‡∏õ‡∏¥‡∏î</option>
                            </select>
                        </div>

                        <button type="submit" id="addMarkerBtn" class="btn-form"
                            style="margin-top:20px; background: linear-gradient(135deg, #059669, #10b981);">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRCO-wzB0sKIjGXw_IPJGSnjcw00ZBGME",
            authDomain: "testlongdomap.firebaseapp.com",
            projectId: "testlongdomap",
            storageBucket: "testlongdomap.firebaseastorage.app",
            messagingSenderId: "391627017137",
            appId: "1:391627017137:web:8221c2540c136bccaf0b90",
            measurementId: "G-BE75QETT05"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.updateDoc = updateDoc;

        window.addEventListener('load', function () {
            setTimeout(function () {
                updateStatus('‚úÖ Database ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î', 5000);
                loadMarkersFromFirebase();
            }, 1000);
        });
    </script>

    <script>
        const userRole = localStorage.getItem("userRole");
        const userProvince = localStorage.getItem("province");
        const userDistrict = localStorage.getItem("district");
        const userSubdistrict = localStorage.getItem("subdistrict");

        //if (!userRole) {
        //    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
        //    window.location.href = "login.html";
        //}

        var map;
        var markers = [];
        var currentLat = 13.736717;
        var currentLon = 100.523186;
        var selectedLat = null;
        var selectedLon = null;
        var radiusCircles = [];
        var infoWindowCloseTimeout;
        var statusTimeout;
        var editingIndex = null;
        var editingMarkerData = null;
        var capacityBars = []; // ‡πÄ‡∏Å‡πá‡∏ö capacity bar overlays


        function init() {
            try {
                if (typeof longdo === 'undefined' || typeof longdo.Map === 'undefined') {
                    console.log('Longdo Map API not yet loaded. Retrying in 500ms...');
                    updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Longdo Map API...', 500);
                    setTimeout(init, 500);
                    return;
                }
                console.log('Longdo Map API loaded successfully. Initializing map...');

                map = new longdo.Map({
                    placeholder: document.getElementById('map'),
                    language: 'th'
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            map.zoom(6); // ‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢
                            map.location({ lon: lon, lat: lat });

                            updateStatus('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 2000);
                        },
                        function (error) {
                            console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ:', error);
                            updateStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ', 5000);
                            // fallback location ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                            map.location({ lon: 100.5018, lat: 13.7563 }); // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
                            map.zoom(6);
                        }
                    );
                } else {
                    updateStatus('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', 5000);
                    map.location({ lon: 100.5018, lat: 13.7563 }); // fallback
                    map.zoom(6);
                }

                map.Event.bind('location', updateCurrentCoordinate);
                updateCurrentCoordinate();
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 5000);
            } catch (error) {
                console.error('Error in init function:', error);
                updateStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ' + error.message, 5000);
            }
        }

        function updateCurrentCoordinate() {
            try {
                var centerLocation = map.location();
                if (centerLocation) {
                    currentLat = centerLocation.lat;
                    currentLon = centerLocation.lon;
                    var coordElem = document.getElementById('currentCoordinate');
                    if (coordElem) {
                        coordElem.innerHTML =
                            '‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î: ' + currentLat.toFixed(6) + '<br>' +
                            '‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î: ' + currentLon.toFixed(6);
                    }
                }
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }

        async function fetchAddressFromLongdoAPI(lat, lon) {
            try {
                const apiKey = '417740672e7626cdcd09c2756d411dde';
                const url = `https://api.longdo.com/map/services/address?lon=${lon}&lat=${lat}&noelevation=1&locale=th&key=${apiKey}`;
                console.log('Calling Longdo Address API with URL:', url);
                const response = await fetch(url);
                const result = await response.json();
                console.log('Longdo Address API Response:', result);

                if (result) {
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠ ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á "‡πÄ‡∏Ç‡∏ï" ‡πÅ‡∏•‡∏∞ "‡πÅ‡∏Ç‡∏ß‡∏á"
                    const cleanPrefix = (text) => {
                        if (text && typeof text === 'string') {
                            if (text.startsWith('‡∏à.')) {
                                return text.substring(2).trim();
                            } else if (text.startsWith('‡∏≠.')) {
                                return text.substring(2).trim();
                            } else if (text.startsWith('‡∏ï.')) {
                                return text.substring(2).trim();
                            } else if (text.startsWith('‡πÄ‡∏Ç‡∏ï')) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏Ç‡∏ï"
                                return text.substring(3).trim(); // ‡∏•‡∏ö '‡πÄ‡∏Ç‡∏ï' (3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
                            } else if (text.startsWith('‡πÅ‡∏Ç‡∏ß‡∏á')) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÅ‡∏Ç‡∏ß‡∏á"
                                return text.substring(4).trim(); // ‡∏•‡∏ö '‡πÅ‡∏Ç‡∏ß‡∏á' (4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
                            }
                        }
                        return text || '';
                    };

                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ cleanPrefix ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á
                    const provinceName = cleanPrefix(result.province);
                    document.getElementById('create_subdistrict').value = cleanPrefix(result.subdistrict);
                    document.getElementById('create_district').value = cleanPrefix(result.district);
                    document.getElementById('create_province').value = provinceName;
                    document.getElementById('create_zipcode').value = result.postcode || '';

                    // üîπ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏Ñ
                    const regionMap = {
                        '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÅ‡∏û‡∏£‡πà', '‡∏ô‡πà‡∏≤‡∏ô', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', '‡∏ï‡∏≤‡∏Å', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå'],
                        '‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î', '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': ['‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', '‡πÄ‡∏•‡∏¢', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç'],
                        '‡πÉ‡∏ï‡πâ': ['‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏™‡∏ï‡∏π‡∏•', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏ï‡∏£‡∏±‡∏á', '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ']
                    };

                    // üîπ ‡∏´‡∏≤ region ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    let regionName = '';
                    for (const [region, provinces] of Object.entries(regionMap)) {
                        if (provinces.includes(provinceName)) {
                            regionName = region;
                            break;
                        }
                    }

                    // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ select
                    if (regionName) {
                        document.getElementById('create_region').value = regionName;
                    }

                    updateStatus('üìç ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 5000);
                } else {
                    updateStatus('üìç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ô‡∏µ‡πâ', 5000);
                }
            } catch (error) {
                console.error('Error fetching address:', error);
                updateStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ' + error.message, 5000);
            }
        }

        function markCenterPosition() {
            try {
                const center = map.location();
                currentLat = center.lat;
                currentLon = center.lon;

                document.getElementById('lat').value = currentLat;
                document.getElementById('lon').value = currentLon;

                fetchAddressFromLongdoAPI(currentLat, currentLon);

            } catch (error) {
                console.error('Error in markCenterPosition:', error);
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ' + error.message, 5000);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 10 ‡∏Å‡∏°. ‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)
        function getZoomLevelForRadius(radiusInMeters) {
            if (radiusInMeters <= 1000) return 15; // 1km or less
            if (radiusInMeters <= 3000) return 14; // 3km
            if (radiusInMeters <= 5000) return 13; // 5km
            if (radiusInMeters <= 10000) return 12; // 10km (‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 10 ‡∏Å‡∏°.)
            if (radiusInMeters <= 20000) return 11; // 20km
            return 10; // Default for larger radii
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function drawAllRadii() {
            try {
                // ‡∏•‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                radiusCircles.forEach(circle => map.Overlays.remove(circle));
                radiusCircles = [];

                var center = map.location(); // ‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏µ
                const radii = [
                    { size: 10000, stroke: 'rgba(255, 190, 0, 1.0)', fill: 'rgba(255, 215, 0, 0.2)', title: '‡∏£‡∏±‡∏®‡∏°‡∏µ 10 ‡∏Å‡∏°. (‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)' }, // 10 ‡∏Å‡∏°. ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                    { size: 5000, stroke: 'rgba(255, 165, 0, 1.0)', fill: 'rgba(255, 190, 0, 0.4)', title: '‡∏£‡∏±‡∏®‡∏°‡∏µ 5 ‡∏Å‡∏°. (‡∏™‡πâ‡∏°‡∏Å‡∏•‡∏≤‡∏á)' },    // 5 ‡∏Å‡∏°. ‡∏™‡πâ‡∏°‡∏Å‡∏•‡∏≤‡∏á
                    { size: 3000, stroke: 'rgba(255, 140, 0, 1.0)', fill: 'rgba(255, 165, 0, 0.6)', title: '‡∏£‡∏±‡∏®‡∏°‡∏µ 3 ‡∏Å‡∏°. (‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)' }  // 3 ‡∏Å‡∏°. ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                ];

                // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏à‡∏≤‡∏Å‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
                radii.forEach(r => {
                    var radiusInDegrees = r.size / longdo.Util.longitudeLength(center.lat);
                    var circleOptions = {
                        fillColor: r.fill,
                        strokeColor: r.stroke,
                        strokeWidth: 3,
                        title: r.title
                    };
                    var circle = new longdo.Circle(center, radiusInDegrees, circleOptions);
                    map.Overlays.add(circle);
                    radiusCircles.push(circle);
                });

                // ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ 10 ‡∏Å‡∏°. ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
                map.location(center, true);
                map.zoom(getZoomLevelForRadius(10000), true); // ‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô 10 ‡∏Å‡∏°.

                updateStatus(`‚≠ï ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏±‡∏®‡∏°‡∏µ 3, 5, ‡πÅ‡∏•‡∏∞ 10 ‡∏Å‡∏°. ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î ${center.lat.toFixed(6)}, ${center.lon.toFixed(6)}`, 5000);
            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏®‡∏°‡∏µ: ' + error.message, 5000);
                console.error('Error drawing circles:', error);
            }
        }

        function canEdit(markerData) {
            const role = localStorage.getItem("userRole");
            const province = localStorage.getItem("province");
            const district = localStorage.getItem("district");
            const subdistrict = localStorage.getItem("subdistrict");

            if (role === 'admin') return true;
            if (role === 'province') return markerData.province === province;
            if (role === 'district') return markerData.province === province && markerData.district === district;
            if (role === 'local') return markerData.province === province && markerData.district === district && markerData.subdistrict === subdistrict;

            return false;
        }

        function canDelete(markerData) {
            const role = localStorage.getItem("userRole");
            const province = localStorage.getItem("province");

            if (role === 'admin') return true;
            if (role === 'province') return markerData.province === province;

            return false; // district ‡πÅ‡∏•‡∏∞ local ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function clearAllRadii() {
            try {
                radiusCircles.forEach(circle => map.Overlays.remove(circle));
                radiusCircles = []; // ‡∏•‡πâ‡∏≤‡∏á array ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                updateStatus('üö´ ‡∏•‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß', 5000);
            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ: ' + error.message, 5000);
            }
        }

        // Fixed version using longdo.Marker with custom HTML
        function createCapacityBar(lat, lon, currentSupport, capacity) {
            if (!capacity || currentSupport == null) return;

            const percent = Math.min((currentSupport / capacity) * 100, 100);

            let color = '#10b981'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            if (percent >= 80) color = '#ef4444'; // ‡πÅ‡∏î‡∏á
            else if (percent >= 50) color = '#facc15'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á

            // Create HTML string for the capacity bar
            const barHtml = `
        <div style="
            position: relative;
            transform: translate(-50%, 10px);
            width: 60px;
            height: 8px;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        ">
            <div style="
                width: ${percent}%;
                height: 100%;
                background: ${color};
                transition: width 0.5s;
            "></div>
        </div>
    `;

            // Create marker with custom HTML icon
            const barMarker = new longdo.Marker(
                { lon: lon, lat: lat },
                {
                    icon: {
                        html: barHtml,
                        offset: { x: 30, y: -4 } // Center the bar
                    },
                    weight: longdo.OverlayWeight.Bottom // Ensure it appears below other markers
                }
            );

            map.Overlays.add(barMarker);
            return barMarker;
        }

        // Alternative version using simple overlay approach
        function createCapacityBarAlternative(lat, lon, currentSupport, capacity) {
            if (!capacity || currentSupport == null) return;

            const percent = Math.min((currentSupport / capacity) * 100, 100);

            let color = '#10b981'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            if (percent >= 80) color = '#ef4444'; // ‡πÅ‡∏î‡∏á
            else if (percent >= 50) color = '#facc15'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á

            // Try using longdo.Overlay if it exists
            if (typeof longdo.Overlay !== 'undefined') {
                const div = document.createElement('div');
                div.style.position = 'relative';
                div.style.transform = 'translate(-50%, 10px)';
                div.style.width = '60px';
                div.style.height = '8px';
                div.style.background = '#ffffff';
                div.style.border = '1px solid #ccc';
                div.style.borderRadius = '4px';
                div.style.overflow = 'hidden';
                div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';

                const fill = document.createElement('div');
                fill.style.width = percent + '%';
                fill.style.height = '100%';
                fill.style.background = color;
                fill.style.transition = 'width 0.5s';

                div.appendChild(fill);

                const overlay = new longdo.Overlay(
                    { location: { lon, lat } },
                    {
                        element: div,
                        offset: { x: 0, y: 20 }
                    }
                );

                map.Overlays.add(overlay);
                return overlay;
            } else {
                // Fallback to marker approach
                return createCapacityBar(lat, lon, currentSupport, capacity);
            }
        }

        function clearCapacityBars() {
            capacityBars.forEach(bar => {
                try {
                    map.Overlays.remove(bar);
                } catch (e) {
                    console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö capacity bar:", e);
                }
            });
            capacityBars = [];
        }


        // Enhanced createMarker function with better error handling
        function createMarker(lat, lon, name, address, active, capacity, markerId, markerIndex, extraData = {}) {
            const percent = (extraData.capacity && extraData.currentSupport != null)
                ? Math.min((extraData.currentSupport / extraData.capacity) * 100, 100)
                : 0;

            const barColor = percent < 50
                ? '#10b981'
                : percent < 80
                    ? '#facc15'
                    : '#ef4444';

            let detail = `
        <div style="padding: 10px; font-size: 14px; line-height: 1.6;">
            <table style="width: 100%; border-collapse: collapse;">
                ${extraData.shelterType ? `<tr><td style="padding: 4px 0;">üè¢ <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏®‡∏π‡∏ô‡∏¢‡πå:</b></td><td>${extraData.shelterType}</td></tr>` : ''}
                ${name ? `<tr><td style="padding: 4px 0;">üë§ <b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b></td><td>${name}</td></tr>` : ''}
                ${extraData.phone ? `<tr><td style="padding: 4px 0;">üìû <b>‡πÇ‡∏ó‡∏£:</b></td><td>${extraData.phone}</td></tr>` : ''}
                ${extraData.region ? `<tr><td style="padding: 4px 0;">üó∫Ô∏è <b>‡∏†‡∏≤‡∏Ñ:</b></td><td>${extraData.region}</td></tr>` : ''}
                ${extraData.province ? `<tr><td style="padding: 4px 0;"><b>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</b></td><td>${extraData.province}</td></tr>` : ''}
                ${extraData.district ? `<tr><td style="padding: 4px 0;"><b>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</b></td><td>${extraData.district}</td></tr>` : ''}
                ${extraData.subdistrict ? `<tr><td style="padding: 4px 0;"><b>‡∏ï‡∏≥‡∏ö‡∏•:</b></td><td>${extraData.subdistrict}</td></tr>` : ''}
                ${extraData.village ? `<tr><td style="padding: 4px 0;"><b>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô:</b></td><td>${extraData.village}</td></tr>` : ''}
                ${extraData.zipcode ? `<tr><td style="padding: 4px 0;"><b>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå:</b></td><td>${extraData.zipcode}</td></tr>` : ''}
                ${address ? `<tr><td style="padding: 4px 0;">üìç <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b></td><td>${address}</td></tr>` : ''}
                <tr><td style="padding: 4px 0;">üåç <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b></td><td>${lat.toFixed(6)}, ${lon.toFixed(6)}</td></tr>
                ${capacity != null ? `<tr><td style="padding: 4px 0;">üë• <b>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:</b></td><td>${capacity.toLocaleString()} ‡∏Ñ‡∏ô</td></tr>` : ''}
                ${extraData.currentSupport != null ? `<tr><td style="padding: 4px 0;">üë§ <b>‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á:</b></td><td>${extraData.currentSupport} ‡∏Ñ‡∏ô</td></tr>` : ''}
                ${extraData.parking ? `<tr><td style="padding: 4px 0;">üöó <b>‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ:</b></td><td>${extraData.parking} ‡∏Ñ‡∏±‡∏ô</td></tr>` : ''}
                ${extraData.toilet ? `<tr><td style="padding: 4px 0;">üöª <b>‡∏™‡∏∏‡∏Ç‡∏≤:</b></td><td>${extraData.toilet}</td></tr>` : ''}
            </table>

            <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                ${extraData.electricity === '‡∏°‡∏µ' ? `<span style="background: #e0f7fa; color: #00796b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span>` : ''}
                ${extraData.water === '‡∏°‡∏µ' ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</span>` : ''}
                ${extraData.wifi === '‡∏°‡∏µ' ? `<span style="background: #ede7f6; color: #4527a0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üì∂ Wifi</span>` : ''}
                ${extraData.pet === '‡∏°‡∏µ' ? `<span style="background: #ffe0b2; color: #e65100; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üê∂ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</span>` : ''}
                ${extraData.tent === '‡∏°‡∏µ' ? `<span style="background: #c8e6c9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚õ∫ ‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</span>` : ''}
            </div>
        </div>
    `;

            if (typeof markerId !== 'undefined' && typeof markerIndex !== 'undefined') {
                detail += `
            <div style='margin:12px 0;'>
                <label class="switch">
                    <input type="checkbox" ${active ? 'checked' : ''} onchange="toggleActive('${markerId}', ${markerIndex}, this.checked)">
                    <span class="slider"></span>
                </label>
                <span style='margin-left:8px; font-weight: 600; color: ${active ? '#10b981' : '#dc2626'};'>${active ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                ${canEdit(extraData) ? `<button onclick="editMarkerFromPopup('${markerId}', ${markerIndex})" style="background:#3b82f6;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                ${canDelete(extraData) ? `<button onclick="deleteMarkerFromPopup('${markerId}', ${markerIndex})" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;">üóëÔ∏è ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>` : ''}
                <button onclick="getDirections(${lat}, ${lon})" style="background:#10b981;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;">üó∫Ô∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
            </div>
        `;
            }

            const markerOptions = {
                title: name,
                detail: detail,
                size: { width: 450, height: 'auto' },
                icon: {
                    url: active ? 'greenMarker.png' : 'redMarker.png',
                    offset: { x: 0, y: -18 },
                    size: { w: 32, h: 32 }
                }
            };

            const marker = new longdo.Marker({ lon: lon, lat: lat }, markerOptions);

            if (marker && marker.Event && typeof marker.Event.bind === 'function') {
                marker.Event.bind('OverlayHover', function () {
                    if (infoWindowCloseTimeout) clearTimeout(infoWindowCloseTimeout);
                    map.InfoWindow.open(marker);
                });

                marker.Event.bind('OverlayLeave', function () {
                    if (infoWindowCloseTimeout) clearTimeout(infoWindowCloseTimeout);
                    infoWindowCloseTimeout = setTimeout(() => map.InfoWindow.close(), 300);
                });

                marker.Event.bind('click', function () {
                    map.InfoWindow.open(marker);
                });
            }

            return marker;
        }

        async function addMarkerWithData() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                var shelterType = document.getElementById('create_shelterType').value;
                if (!["‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô", "‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].includes(shelterType)) shelterType = '';
                var name = document.getElementById('create_fullName').value.trim();
                var phone = document.getElementById('create_phone').value.trim();
                var region = document.getElementById('create_region').value;
                var province = document.getElementById('create_province').value.trim();
                var district = document.getElementById('create_district').value.trim();
                var subdistrict = document.getElementById('create_subdistrict').value.trim();
                var village = document.getElementById('create_village').value.trim();
                var zipcode = document.getElementById('create_zipcode').value.trim();
                var place = document.getElementById('create_place').value.trim();
                var lat = document.getElementById('create_lat').value;
                var lon = document.getElementById('create_lon').value;
                var electricity = document.getElementById('create_electricity').value;
                var water = document.getElementById('create_water').value;
                var wifi = document.getElementById('create_wifi').value;
                var pet = document.getElementById('create_pet').value;
                var tent = document.getElementById('create_tent').value;
                var toilet = document.getElementById('create_toilet').value.trim();
                var parking = document.getElementById('create_parking').value.trim();
                var canSupport = document.getElementById('create_canSupport').value;
                var currentSupport = document.getElementById('create_currentSupport').value;
                var status = document.getElementById('create_status').value;
                if (!status) status = '‡πÄ‡∏õ‡∏¥‡∏î';
                var active = (status === '‡πÄ‡∏õ‡∏¥‡∏î');

                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
                    return;
                }

                var addBtn = document.getElementById('addMarkerBtn');
                var originalText = addBtn.textContent;
                addBtn.textContent = 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                addBtn.disabled = true;

                var markerData = {
                    shelterType: shelterType || '',
                    name: name,
                    phone: phone || '',
                    region: region || '',
                    province: province || '',
                    district: district || '',
                    subdistrict: subdistrict || '',
                    village: village || '',
                    zipcode: zipcode || '',
                    address: place || '',
                    lat: lat ? parseFloat(lat) : currentLat,
                    lon: lon ? parseFloat(lon) : currentLon,
                    electricity: electricity || '',
                    water: water || '',
                    wifi: wifi || '',
                    pet: pet || '',
                    tent: tent || '',
                    toilet: toilet || '',
                    parking: parking || '',
                    capacity: canSupport ? parseInt(canSupport) : null,
                    currentSupport: currentSupport ? parseInt(currentSupport) : null,
                    active: active,
                    createdAt: new Date(),
                    timestamp: Date.now(),
                };

                // Save to Firebase Firestore
                const docRef = await window.addDoc(window.collection(window.db, "markers"), markerData);

                // Add marker to map
                var marker = createMarker(markerData.lat, markerData.lon, name, place, false, markerData.capacity, docRef.id, markers.length, markerData); // ‡πÉ‡∏ä‡πâ docRef.id ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                map.Overlays.add(marker);
                const bar = createCapacityBar(markerData.lat, markerData.lon, markerData.currentSupport, markerData.capacity);
                if (bar) capacityBars.push(bar);

                markerData.id = docRef.id;
                markerData.marker = marker;
                markerData.createdAt = markerData.createdAt.toLocaleString('th-TH');
                markers.push(markerData);
                updateMarkersList();
                clearForm();
                closeCreateModal();
                loadMarkersFromFirebase();
                updateStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "' + name + '" ‡πÉ‡∏ô Database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 5000);

                addBtn.textContent = originalText;
                addBtn.disabled = false;

            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message, 5000);
                var addBtn = document.getElementById('addMarkerBtn');
                addBtn.textContent = originalText;
                addBtn.disabled = false;
                console.error('Error adding marker with data:', error);
            }
        }

        async function loadMarkersFromFirebase() {
            try {
                updateStatus('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Database...', 0);
                markers.forEach(markerData => {
                    if (markerData.marker) {
                        map.Overlays.remove(markerData.marker);
                    }
                });
                markers = []; // Clear local markers array

                const markersCol = window.collection(window.db, 'markers');
                const q = window.query(markersCol, window.orderBy('timestamp', 'desc'));
                const querySnapshot = await window.getDocs(q);

                if (querySnapshot.empty) {
                    updateStatus('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô Database', 5000);
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const marker = createMarker(data.lat, data.lon, data.name, data.address, data.active, data.capacity, doc.id, markers.length, data);
                        map.Overlays.add(marker);
                        const bar = createCapacityBar(data.lat, data.lon, data.currentSupport, data.capacity);
                        if (bar) capacityBars.push(bar);

                        // Store marker with its ID and original data
                        markers.push({
                            id: doc.id,
                            marker: marker,
                            ...data
                        });
                    });
                    updateStatus(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î ${markers.length} ‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏Å Database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 5000);
                }
                updateMarkersList();
            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 5000);
                console.error('Error loading markers from Firebase:', error);
            }
        }

        function updateMarkersList(filteredList = null) {
            const data = filteredList || markers;

            clearCapacityBars();

            var markersListDiv = document.getElementById('markersList');
            var markerCountSpan = document.getElementById('markerCount');
            markersListDiv.innerHTML = ''; // Clear current list
            markerCountSpan.textContent = data.length;

            if (markers.length === 0) {
                markersListDiv.innerHTML = `
                    <div class="empty-state">
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</p>
                        <p>‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                `;
                return;
            }

            // Sort markers by creation timestamp (latest first)
            const sortedMarkers = [...data].sort((a, b) => b.timestamp - a.timestamp);

            sortedMarkers.forEach((markerData, index) => {
                var markerItem = document.createElement('div');
                markerItem.className = 'marker-item';
                markerItem.setAttribute('data-id', markerData.id);
                markerItem.innerHTML = `
                    <div class="marker-header">
                        <div style="flex-grow: 1;">
                            <div class="marker-name">${markerData.name}</div>
                            <div class="marker-details">
                                ${markerData.subdistrict || ''} ${markerData.district || ''} ${markerData.province || ''} ${markerData.zipcode || ''}<br>
                                ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${markerData.lat.toFixed(6)}, ${markerData.lon.toFixed(6)}<br>
                                ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ${markerData.capacity !== null && markerData.capacity !== undefined ? markerData.capacity.toLocaleString() : 'N/A'} ‡∏Ñ‡∏ô (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${markerData.currentSupport !== null && markerData.currentSupport !== undefined ? markerData.currentSupport.toLocaleString() : 'N/A'} ‡∏Ñ‡∏ô)<br>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${markerData.createdAt}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" ${markerData.active ? 'checked' : ''} onchange="toggleActive('${markerData.id}', ${index}, this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span style='font-weight: 600; color: ${markerData.active ? '#10b981' : '#dc2626'};'>${markerData.active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                        ${markerData.electricity === '‡∏°‡∏µ' ? `<span style="background: #e0f7fa; color: #00796b; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span>` : ''}
                        ${markerData.water === '‡∏°‡∏µ' ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</span>` : ''}
                        ${markerData.wifi === '‡∏°‡∏µ' ? `<span style="background: #ede7f6; color: #4527a0; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">üì∂ Wifi</span>` : ''}
                        ${markerData.pet === '‡∏°‡∏µ' ? `<span style="background: #ffe0b2; color: #e65100; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">üê∂ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</span>` : ''}
                        ${markerData.tent === '‡∏°‡∏µ' ? `<span style="background: #c8e6c9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">‚õ∫ ‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå</span>` : ''}
                        ${markerData.parking ? `<span style="background: #fff3e0; color: #ff6f00; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">üÖøÔ∏è ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ: ${markerData.parking}</span>` : ''}
                        ${markerData.toilet ? `<span style="background: #fce4ec; color: #ad1457; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">üöª ‡∏™‡∏∏‡∏Ç‡∏≤: ${markerData.toilet}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn-secondary" style="flex:1;" onclick="map.location({ lat: ${markerData.lat}, lon: ${markerData.lon} }, true, 16);">‡∏î‡∏π‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
                        ${canEdit(markerData) ? `<button class="btn-secondary" style="background-color: #3b82f6; flex:1;" onclick="editMarkerFromPopup('${markerData.id}', ${index})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                        <button class="btn-secondary" style="background-color: #10b981; flex:1;" onclick="getDirections(${markerData.lat}, ${markerData.lon})">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                        ${canDelete(markerData) ? `<button class="btn-secondary" style="background-color: #ef4444; flex:1;" onclick="deleteMarker('${markerData.id}', ${index})">‡∏•‡∏ö</button>` : ''}
                    </div>
                `;
                markersListDiv.appendChild(markerItem);
                const bar = createCapacityBar(markerData.lat, markerData.lon, markerData.currentSupport, markerData.capacity);
                if (bar) capacityBars.push(bar);
            });
        }

        async function deleteMarker(markerId, index) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) {
                try {
                    updateStatus(`üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î ID: ${markerId}...`, 0);
                    await window.deleteDoc(window.doc(window.db, 'markers', markerId));
                    // Remove from map
                    if (markers[index] && markers[index].marker) {
                        map.Overlays.remove(markers[index].marker);
                    }
                    // Remove from local array
                    markers.splice(index, 1);
                    updateMarkersList();
                    updateStatus('‚úÖ ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 5000);
                } catch (error) {
                    updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î: ' + error.message, 5000);
                    console.error('Error deleting marker:', error);
                }
            }
        }

        async function toggleActive(markerId, index, newStatus) {
            const markerData = markers[index];

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô
            if (!canEdit(markerData)) {
                alert("‚õîÔ∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ");

                // ‚ùó ‡∏¢‡πâ‡∏≠‡∏ô checkbox ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°
                const checkbox = document.querySelector(`input[type="checkbox"][onchange*="'${markerId}'"]`);
                if (checkbox) {
                    checkbox.checked = markerData.active; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
                }

                return;
            }

            try {
                updateStatus(`üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏°‡∏∏‡∏î ID: ${markerId}...`, 0);
                const markerRef = window.doc(window.db, 'markers', markerId);
                await window.updateDoc(markerRef, { active: newStatus });

                // Update local array and map marker
                if (markers[index]) {
                    markers[index].active = newStatus;

                    // ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°
                    map.Overlays.remove(markers[index].marker);

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
                    markers[index].marker = createMarker(
                        markers[index].lat,
                        markers[index].lon,
                        markers[index].name,
                        markers[index].address,
                        newStatus,
                        markers[index].capacity,
                        markers[index].id,
                        index,
                        markers[index]
                    );

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    map.Overlays.add(markers[index].marker);
                }

                updateMarkersList();
                updateStatus('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 5000);
            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + error.message, 5000);
                console.error('Error updating marker status:', error);
            }
        }

        async function updateMarker(markerId, index) {
            try {
                var shelterType = document.getElementById('shelterType').value;
                if (!["‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô", "‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].includes(shelterType)) shelterType = '';
                var name = document.getElementById('fullName').value.trim();
                var phone = document.getElementById('phone').value.trim();
                var region = document.getElementById('region').value;
                var province = document.getElementById('province').value.trim();
                var district = document.getElementById('district').value.trim();
                var subdistrict = document.getElementById('subdistrict').value.trim();
                var village = document.getElementById('village').value.trim();
                var zipcode = document.getElementById('zipcode').value.trim();
                var place = document.getElementById('place').value.trim();
                var lat = document.getElementById('lat').value;
                var lon = document.getElementById('lon').value;
                var electricity = document.getElementById('electricity').value;
                var water = document.getElementById('water').value;
                var wifi = document.getElementById('wifi').value;
                var pet = document.getElementById('pet').value;
                var tent = document.getElementById('tent').value;
                var toilet = document.getElementById('toilet').value.trim();
                var parking = document.getElementById('parking').value.trim();
                var canSupport = document.getElementById('canSupport').value;
                var currentSupport = document.getElementById('currentSupport').value;
                var status = document.getElementById('status').value;
                if (!status) status = '‡πÄ‡∏õ‡∏¥‡∏î';
                var active = (status === '‡πÄ‡∏õ‡∏¥‡∏î');

                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
                    return;
                }

                var updateBtn = document.getElementById('addMarkerBtn');
                var originalText = updateBtn.textContent;
                updateBtn.textContent = 'üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...';
                updateBtn.disabled = true;

                const updatedData = {
                    shelterType: shelterType || '',
                    name: name,
                    phone: phone || '',
                    region: region || '',
                    province: province || '',
                    district: district || '',
                    subdistrict: subdistrict || '',
                    village: village || '',
                    zipcode: zipcode || '',
                    address: place || '',
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    electricity: electricity || '',
                    water: water || '',
                    wifi: wifi || '',
                    pet: pet || '',
                    tent: tent || '',
                    toilet: toilet || '',
                    parking: parking || '',
                    capacity: canSupport ? parseInt(canSupport) : null,
                    currentSupport: currentSupport ? parseInt(currentSupport) : null,
                    active: active,
                    updatedAt: new Date(),
                };

                const markerRef = window.doc(window.db, 'markers', markerId);
                await window.updateDoc(markerRef, updatedData);

                // Update local array
                const markerIndex = markers.findIndex(m => m.id === markerId);
                if (markerIndex !== -1) {
                    // Remove old marker from map
                    if (markers[markerIndex] && markers[markerIndex].marker) {
                        map.Overlays.remove(markers[markerIndex].marker);
                    }
                    // Create new marker with updated data
                    const newMarker = createMarker(updatedData.lat, updatedData.lon, updatedData.name, updatedData.address, updatedData.active, updatedData.capacity, markerId, markerIndex, updatedData);
                    map.Overlays.add(newMarker);

                    markers[markerIndex] = {
                        id: markerId,
                        marker: newMarker,
                        ...updatedData,
                        createdAt: markers[markerIndex].createdAt, // Keep original creation date
                        timestamp: markers[markerIndex].timestamp // Keep original timestamp
                    };
                    markers[markerIndex].updatedAt = new Date().toLocaleString('th-TH');
                }

                updateMarkersList();
                clearForm();
                updateStatus('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "' + name + '" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 5000);

                // Reset form button to add mode
                updateBtn.textContent = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                updateBtn.onclick = function () {
                    addMarkerWithData();
                };
                updateBtn.style.background = 'linear-gradient(135deg, #059669, #10b981)'; // Green gradient
                updateBtn.disabled = false;

            } catch (error) {
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + error.message, 5000);
                var updateBtn = document.getElementById('addMarkerBtn');
                updateBtn.textContent = originalText;
                updateBtn.disabled = false;
                console.error('Error updating marker:', error);
            }
        }

        function editMarkerFromPopup(markerId, index) {
            const markerData = markers.find(m => m.id === markerId);
            if (!markerData) return;

            // üîí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            if (!canEdit(markerData)) {
                alert("‚õîÔ∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ");
                return;
            }

            if (map && map.InfoWindow && typeof map.InfoWindow.close === 'function') {
                map.InfoWindow.close();
            }

            openEditModal(markerData, index);
        }

        function waitForContainerReady(containerId, callback, tryCount = 0) {
            const el = document.getElementById(containerId);
            if (!el) {
                console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö div #' + containerId);
                return;
            }
            const rect = el.getBoundingClientRect();
            if (rect.width > 10 && rect.height > 10) {
                callback();
            } else if (tryCount < 10) {
                setTimeout(() => waitForContainerReady(containerId, callback, tryCount + 1), 50);
            } else {
                console.error('Container #' + containerId + ' ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏Ç‡∏ô‡∏≤‡∏î 0x0 px)');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Create Modal
        function openCreateModal() {
            const createModal = document.getElementById('createModal');
            createModal.classList.add('edit-modal');
            createModal.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á modal

            // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const createMarkerForm = document.getElementById('createMarkerForm');
            if (createMarkerForm) {
                createMarkerForm.reset();
            }

            updateStatus('‚ûï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà...', 5000);

            // 2. ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Create Modal ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    setTimeout(() => {
                        console.log('Create Modal displayed successfully, initializing map with user location...');
                        if (typeof initCreateMap === 'function') {
                            initCreateMap(userLat, userLon); // ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÉ‡∏´‡πâ initCreateMap
                        } else {
                            console.error('initCreateMap function is not defined!');
                        }
                    }, 100);

                    updateStatus('‚ûï ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)', 5000);

                }, function (error) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ
                    console.error('Error getting user location:', error);
                    updateStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ó‡∏ô', 5000);

                    // Fallback: ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å (currentLat, currentLon) ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    document.getElementById('create_lat').value = currentLat.toFixed(6);
                    document.getElementById('create_lon').value = currentLon.toFixed(6);

                    setTimeout(() => {
                        console.log('Create Modal displayed successfully, initializing map with fallback location...');
                        if (typeof initCreateMap === 'function') {
                            initCreateMap(currentLat, currentLon); // ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô fallback
                        } else {
                            console.error('initCreateMap function is not defined!');
                        }
                    }, 100);
                });
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation API
                updateStatus('‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ó‡∏ô', 5000);
                console.error('Geolocation is not supported by this browser.');

                // Fallback: ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å (currentLat, currentLon) ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation
                document.getElementById('create_lat').value = currentLat.toFixed(6);
                document.getElementById('create_lon').value = currentLon.toFixed(6);

                setTimeout(() => {
                    console.log('Create Modal displayed successfully, initializing map with fallback location...');
                    if (typeof initCreateMap === 'function') {
                        initCreateMap(currentLat, currentLon); // ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô fallback
                    } else {
                        console.error('initCreateMap function is not defined!');
                    }
                }, 100);
            }
        }

        var createMap; // ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
        var createCurrentMarker; // ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Create Modal
        // ‡∏£‡∏±‡∏ö initialLat ‡πÅ‡∏•‡∏∞ initialLon ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        function initCreateMap(initialLat, initialLon) {
            try {
                console.log('Initializing create map at coordinates:', initialLat, initialLon);

                // 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Longdo API ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                if (typeof longdo === 'undefined' || typeof longdo.Map === 'undefined') {
                    console.warn('Longdo API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö createMap ‡∏£‡∏≠ 300ms ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    setTimeout(() => initCreateMap(initialLat, initialLon), 300); // ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô setTimeout ‡∏î‡πâ‡∏ß‡∏¢
                    return;
                }

                // 2) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ container ‡∏û‡∏£‡πâ‡∏≠‡∏°
                const createMapContainer = document.getElementById('createMap');
                if (!createMapContainer) {
                    console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö div #createMap');
                    return;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ container ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                if (createMapContainer.offsetWidth === 0 || createMapContainer.offsetHeight === 0) {
                    console.warn('Edit map container has no dimensions, retrying...');
                    setTimeout(() => initEditMap(lat, lon), 500);
                    return;
                }

                // 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                createMap = new longdo.Map({
                    placeholder: createMapContainer,
                    language: 'th',
                    zoom: 15 // ‡∏ã‡∏π‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                });

                setTimeout(() => {
                    try {
                        if (createMap && typeof createMap.location === 'function') {
                            createMap.location({ lon: initialLon, lat: initialLat }); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤

                            // ‡∏•‡∏ö marker ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                            if (createCurrentMarker) {
                                try {
                                    createMap.Overlays.remove(createCurrentMarker);
                                } catch (e) {
                                    console.warn('Could not remove previous marker:', e);
                                }
                            }

                            // 5) ‡∏ß‡∏≤‡∏á marker (‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á)
                            createCurrentMarker = new longdo.Marker({ lon: initialLon, lat: initialLat }, {
                                title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà',
                                detail: '‡∏•‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
                            });

                            // 6) Event click ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢ marker ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                            createMap.Event.bind('click', function (overlay, location) {
                                if (createCurrentMarker) {
                                    createCurrentMarker.Location({ lon: location.lon, lat: location.lat }); // ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                                    document.getElementById('create_lat').value = location.lat.toFixed(6);
                                    document.getElementById('create_lon').value = location.lon.toFixed(6);
                                }
                            });

                            console.log('Create map initialized successfully');
                            updateStatus('‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 3000);
                        }
                    } catch (setupError) {
                        console.error('Error setting up create map:', setupError);
                        updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 3000);
                    }
                }, 500);

            } catch (error) {
                console.error('Error initializing create map:', error);
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 3000);
                setTimeout(() => {
                    console.log('Retrying edit map initialization...');
                    initEditMap(lat, lon);
                }, 2000);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ" ‡πÉ‡∏ô createModal
        function selectCurrentLocationCreate() {
            if (typeof createMap !== 'undefined' && createMap !== null) {
                // 1. ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Create Modal
                const center = createMap.location();

                // 2. ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á lat/lon ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° Create
                document.getElementById('create_lat').value = center.lat.toFixed(6);
                document.getElementById('create_lon').value = center.lon.toFixed(6);

                // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ fetchAddressFromLongdoAPI

                if (typeof fetchAddressFromLongdoAPI === 'function') {
                    fetchAddressFromLongdoAPI(center.lat, center.lon, 'create'); // 'create' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Create Modal
                } else {
                    console.warn('fetchAddressFromLongdoAPI function is not defined. Address will not be auto-filled.');
                }

                updateStatus(`üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà: ${center.lat.toFixed(6)}, ${center.lon.toFixed(6)}`, 3000);

                // ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î modal ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ
                // ‡πÄ‡∏ä‡πà‡∏ô closeCreateModal(); ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î
            } else {
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà', 3000);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î Create Modal
        function closeCreateModal() {
            try {
                const createModal = document.getElementById('createModal');
                if (createModal) {
                    createModal.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô modal
                }

                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô createMarkerForm
                const createForm = document.getElementById('createMarkerForm');
                if (createForm) {
                    createForm.reset(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                }

                // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô createModal ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ñ‡πâ‡∏≤ initCreateMap ‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                if (typeof createMap !== 'undefined' && createMap !== null) {
                    try {
                        if (typeof createCurrentMarker !== 'undefined' && createCurrentMarker !== null) {
                            createMap.Overlays.remove(createCurrentMarker); // ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                        }
                        const container = document.getElementById('createMap');
                        if (container) container.innerHTML = ''; // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ã‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    } catch (e) {
                        console.warn('Error destroying create map:', e);
                    }
                    createMap = null; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                }
                createCurrentMarker = null; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô null

                updateStatus('‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß', 3000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

            } catch (error) {
                console.error('Error closing create modal:', error);
            }
        }

        function openEditModal(markerData, index) {
            editingIndex = index;
            editingMarkerData = markerData;

            console.log('Opening edit modal for marker:', markerData);
            console.log('editingIndex:', editingIndex);
            console.log('markers array length:', markers.length);

            // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('edit_shelterType').value = markerData.shelterType || '';
            document.getElementById('edit_fullName').value = markerData.name || '';
            document.getElementById('edit_phone').value = markerData.phone || '';
            document.getElementById('edit_region').value = markerData.region || '';
            document.getElementById('edit_province').value = markerData.province || '';
            document.getElementById('edit_district').value = markerData.district || '';
            document.getElementById('edit_subdistrict').value = markerData.subdistrict || '';
            document.getElementById('edit_village').value = markerData.village || '';
            document.getElementById('edit_zipcode').value = markerData.zipcode || '';
            document.getElementById('edit_place').value = markerData.address || '';
            document.getElementById('edit_lat').value = markerData.lat || '';
            document.getElementById('edit_lon').value = markerData.lon || '';
            document.getElementById('edit_electricity').value = markerData.electricity || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
            document.getElementById('edit_water').value = markerData.water || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
            document.getElementById('edit_wifi').value = markerData.wifi || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
            document.getElementById('edit_pet').value = markerData.pet || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
            document.getElementById('edit_tent').value = markerData.tent || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
            document.getElementById('edit_toilet').value = markerData.toilet || '';
            document.getElementById('edit_parking').value = markerData.parking || '';
            document.getElementById('edit_canSupport').value = markerData.capacity !== null && markerData.capacity !== undefined ? markerData.capacity : '';
            document.getElementById('edit_currentSupport').value = markerData.currentSupport !== null && markerData.currentSupport !== undefined ? markerData.currentSupport : '';
            document.getElementById('edit_status').value = markerData.active ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î';

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('editModal').classList.add('edit-modal');
            document.getElementById('editModal').style.display = 'flex';

            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ modal ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            setTimeout(() => {
                console.log('Modal displayed successfully');
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°
                const lat = parseFloat(markerData.lat);
                const lon = parseFloat(markerData.lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    initEditMap(lat, lon);
                } else {
                    console.error('Invalid coordinates for edit map:', markerData.lat, markerData.lon);
                }
            }, 600);

            updateStatus(`üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${markerData.name}`, 5000);
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        let editMap = null;
        let editCurrentMarker = null;

        function initEditMap(lat, lon) {
            try {
                console.log('Initializing edit map at coordinates:', lat, lon);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ longdo API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                if (typeof longdo === 'undefined' || !longdo.Map) {
                    console.error('Longdo Map API not loaded yet');
                    setTimeout(() => initEditMap(lat, lon), 1000);
                    return;
                }

                const editMapContainer = document.getElementById('editMap');
                if (!editMapContainer) {
                    console.error('Edit map container not found');
                    return;
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ container ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                if (editMapContainer.offsetWidth === 0 || editMapContainer.offsetHeight === 0) {
                    console.warn('Edit map container has no dimensions, retrying...');
                    setTimeout(() => initEditMap(lat, lon), 500);
                    return;
                }

                // ‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (editMap) {
                    try {
                        editMap.destroy();
                    } catch (e) {
                        console.warn('Could not destroy previous edit map:', e);
                    }
                    editMap = null;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                editMap = new longdo.Map({
                    placeholder: editMapContainer,
                    language: 'th',
                    zoom: 15
                });

                setTimeout(() => {
                    try {
                        if (editMap && typeof editMap.location === 'function') {
                            editMap.location({ lon: lon, lat: lat });


                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡∏°‡πà
                            editCurrentMarker = new longdo.Marker({ lon: lon, lat: lat }, {
                                title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',
                                detail: '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà'
                            });

                            // bind event click ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                            editMap.Event.bind('click', function (location) {
                                try {
                                    if (editCurrentMarker && location) {
                                        editCurrentMarker.location({ lon: location.lon, lat: location.lat });
                                        const latInput = document.getElementById('edit_lat');
                                        const lonInput = document.getElementById('edit_lon');
                                        if (latInput) latInput.value = location.lat.toFixed(6);
                                        if (lonInput) lonInput.value = location.lon.toFixed(6);
                                        updateStatus(`üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà: ${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}`, 3000);
                                    }
                                } catch (clickError) {
                                    console.error('Error handling map click:', clickError);
                                }
                            });

                            console.log('Edit map initialized successfully');
                            updateStatus('‚úÖ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 3000);
                        }
                    } catch (setupError) {
                        console.error('Error setting up edit map:', setupError);
                        updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 3000);
                    }
                }, 500);

            } catch (error) {
                console.error('Error initializing edit map:', error);
                updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 3000);
                setTimeout(() => {
                    console.log('Retrying edit map initialization...');
                    initEditMap(lat, lon);
                }, 2000);
            }
        }

        async function fetchAddressForEdit(lat, lon) {
            try {
                const apiKey = '417740672e7626cdcd09c2756d411dde';
                const url = `https://api.longdo.com/map/services/address?lon=${lon}&lat=${lat}&noelevation=1&locale=th&key=${apiKey}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result) {
                    const cleanPrefix = (text) => {
                        if (text && typeof text === 'string') {
                            if (text.startsWith('‡∏à.')) return text.substring(2).trim();
                            else if (text.startsWith('‡∏≠.')) return text.substring(2).trim();
                            else if (text.startsWith('‡∏ï.')) return text.substring(2).trim();
                            else if (text.startsWith('‡πÄ‡∏Ç‡∏ï')) return text.substring(3).trim();
                            else if (text.startsWith('‡πÅ‡∏Ç‡∏ß‡∏á')) return text.substring(4).trim();
                        }
                        return text || '';
                    };

                    // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•/‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
                    const provinceName = cleanPrefix(result.province);
                    document.getElementById('edit_subdistrict').value = cleanPrefix(result.subdistrict);
                    document.getElementById('edit_district').value = cleanPrefix(result.district);
                    document.getElementById('edit_province').value = provinceName;
                    document.getElementById('edit_zipcode').value = result.postcode || '';

                    // ‡πÄ‡∏ã‡πá‡∏ï‡∏†‡∏≤‡∏Ñ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    const regionMap = {
                        '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', '‡∏•‡∏≥‡∏û‡∏π‡∏ô', '‡πÅ‡∏û‡∏£‡πà', '‡∏ô‡πà‡∏≤‡∏ô', '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô', '‡∏ï‡∏≤‡∏Å', '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£', '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢', '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å', '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå', '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå'],
                        '‡∏Å‡∏•‡∏≤‡∏á': ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£', '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á', '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ', '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó', '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ', '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤', '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å': ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏∞‡∏¢‡∏≠‡∏á', '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ï‡∏£‡∏≤‡∏î', '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß', '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å': ['‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ', '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ', '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå'],
                        '‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©', '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå', '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°', '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î', '‡∏¢‡πÇ‡∏™‡∏ò‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°', '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£', '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå', '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π', '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢', '‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨', '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥', '‡πÄ‡∏•‡∏¢', '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç'],
                        '‡πÉ‡∏ï‡πâ': ['‡∏™‡∏á‡∏Ç‡∏•‡∏≤', '‡∏™‡∏ï‡∏π‡∏•', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏ï‡∏£‡∏±‡∏á', '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏£‡∏∞‡∏ô‡∏≠‡∏á', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', '‡∏¢‡∏∞‡∏•‡∏≤', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ']
                    };
                    let regionName = '';
                    for (const [region, provinces] of Object.entries(regionMap)) {
                        if (provinces.includes(provinceName)) {
                            regionName = region;
                            break;
                        }
                    }
                    if (regionName) {
                        document.getElementById('edit_region').value = regionName;
                    }

                    updateStatus('üìç ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 3000);
                }
            } catch (error) {
                console.error('Error fetching address for edit:', error);
                updateStatus('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 3000);
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
        function selectCurrentLocation() {
            if (editMap) {
                // 1. ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                const center = editMap.location();

                // 2. ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á lat/lon
                document.getElementById('edit_lat').value = center.lat.toFixed(6);
                document.getElementById('edit_lon').value = center.lon.toFixed(6);

                // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                fetchAddressForEdit(center.lat, center.lon);

                updateStatus(`üìç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà: ${center.lat.toFixed(6)}, ${center.lon.toFixed(6)}`, 3000);
            } else {
                updateStatus('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 3000);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î modal ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
        function closeEditModal() {
            try {
                const modal = document.getElementById('editModal');
                if (modal) {
                    modal.classList.remove('edit-modal');
                    modal.style.display = 'none';
                }

                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                editingIndex = null;
                editingMarkerData = null;

                // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                if (editMap) {
                    try {
                        if (editCurrentMarker) {
                            editMap.Overlays.remove(editCurrentMarker);
                        }
                        const container = document.getElementById('editMap');
                        if (container) container.innerHTML = ''; // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ã‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    } catch (e) {
                        console.warn('Error destroying edit map:', e);
                    }
                    editMap = null;
                }

                editCurrentMarker = null;

                updateStatus('üìù ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß', 3000);
            } catch (error) {
                console.error('Error closing edit modal:', error);
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        document.addEventListener('DOMContentLoaded', function () {
            const editMarkerForm = document.getElementById('editMarkerForm');
            const createMarkerForm = document.getElementById('createMarkerForm');
            if (editMarkerForm) {
                editMarkerForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const name = document.getElementById('edit_fullName').value.trim();
                    const lat = parseFloat(document.getElementById('edit_lat').value);
                    const lon = parseFloat(document.getElementById('edit_lon').value);
                    const shelterType = document.getElementById('edit_shelterType').value;
                    const phone = document.getElementById('edit_phone').value.trim();
                    const region = document.getElementById('edit_region').value;
                    const province = document.getElementById('edit_province').value.trim();
                    const district = document.getElementById('edit_district').value.trim();
                    const subdistrict = document.getElementById('edit_subdistrict').value.trim();
                    const village = document.getElementById('edit_village').value.trim();
                    const zipcode = document.getElementById('edit_zipcode').value.trim();
                    const place = document.getElementById('edit_place').value.trim();
                    const electricity = document.getElementById('edit_electricity').value;
                    const water = document.getElementById('edit_water').value;
                    const wifi = document.getElementById('edit_wifi').value;
                    const pet = document.getElementById('edit_pet').value;
                    const tent = document.getElementById('edit_tent').value;
                    const toilet = document.getElementById('edit_toilet').value.trim();
                    const parking = document.getElementById('edit_parking').value.trim();
                    const canSupport = document.getElementById('edit_canSupport').value;
                    const currentSupport = document.getElementById('edit_currentSupport').value;
                    const status = document.getElementById('edit_status').value;
                    const active = (status === '‡πÄ‡∏õ‡∏¥‡∏î');

                    if (!name) {
                        updateStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', 3000);
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•');
                        return;
                    }

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ editingIndex ‡πÅ‡∏•‡∏∞ markers[editingIndex] ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    if (editingIndex === null || editingIndex === undefined || !markers[editingIndex]) {
                        updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 5000);
                        console.error('editingIndex:', editingIndex, 'markers:', markers);
                        return;
                    }

                    const updatedData = {
                        shelterType: shelterType || '',
                        name: name,
                        phone: phone || '',
                        region: region || '',
                        province: province || '',
                        district: district || '',
                        subdistrict: subdistrict || '',
                        village: village || '',
                        zipcode: zipcode || '',
                        address: place || '',
                        lat: lat,
                        lon: lon,
                        electricity: electricity || '',
                        water: water || '',
                        wifi: wifi || '',
                        pet: pet || '',
                        tent: tent || '',
                        toilet: toilet || '',
                        parking: parking || '',
                        capacity: canSupport ? parseInt(canSupport) : null,
                        currentSupport: currentSupport ? parseInt(currentSupport) : null,
                        active: active,
                        updatedAt: new Date()
                    };

                    try {
                        console.log('Updating marker with ID:', markers[editingIndex].id);
                        console.log('Updated data:', updatedData);

                        const markerRef = window.doc(window.db, 'markers', markers[editingIndex].id);
                        await window.updateDoc(markerRef, updatedData);

                        // ‡∏•‡∏ö marker ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å
                        if (markers[editingIndex].marker) {
                            map.Overlays.remove(markers[editingIndex].marker);
                        }

                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡∏°‡πà
                        const newMarker = createMarker(lat, lon, name, place, active, updatedData.capacity, markers[editingIndex].id, editingIndex, updatedData);
                        map.Overlays.add(newMarker);

                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô array
                        markers[editingIndex] = {
                            ...markers[editingIndex],
                            ...updatedData,
                            marker: newMarker
                        };

                        updateMarkersList();
                        updateStatus("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", 5000);
                        closeEditModal();
                    } catch (err) {
                        console.error('Error updating marker:', err);
                        updateStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + err.message, 5000);
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: " + err.message);
                    }
                });
            } else {
                console.error('element not found');
            }
        })

        async function deleteMarkerFromPopup(markerId, index) {
            const markerData = markers.find(m => m.id === markerId);
            if (!markerData) return;

            // üîí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
            if (!canDelete(markerData)) {
                alert("‚õîÔ∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ô‡∏µ‡πâ");
                return;
            }

            if (map && map.InfoWindow && typeof map.InfoWindow.close === 'function') {
                map.InfoWindow.close();
            }

            await deleteMarker(markerId, index); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏•‡∏±‡∏Å
        }

        function clearForm() {
            document.getElementById('createMarkerForm').reset();
            document.getElementById('editMarkerForm').reset();
            document.getElementById('create_lat').value = '';
            document.getElementById('create_lon').value = '';
            document.getElementById('create_subdistrict').value = '';
            document.getElementById('create_district').value = '';
            document.getElementById('create_province').value = '';
            document.getElementById('create_zipcode').value = '';
            document.getElementById('edit_lat').value = '';
            document.getElementById('edit_lon').value = '';
            document.getElementById('edit_subdistrict').value = '';
            document.getElementById('edit_district').value = '';
            document.getElementById('edit_province').value = '';
            document.getElementById('edit_zipcode').value = '';
        }

        function updateStatus(message, duration = 0) {
            var statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;

                // Clear previous timeout if exists
                if (statusTimeout) {
                    clearTimeout(statusTimeout);
                }

                // Set new timeout if duration is provided and greater than 0
                if (duration > 0) {
                    statusTimeout = setTimeout(() => {
                        statusDiv.textContent = ''; // Clear the message
                    }, duration);
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        function getDirections(lat, lon) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const originLat = position.coords.latitude;
                    const originLon = position.coords.longitude;
                    // ‡πÉ‡∏ä‡πâ domain ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Maps
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLon}&destination=${lat},${lon}&travelmode=driving`;
                    window.open(googleMapsUrl, '_blank');
                }, function (error) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ: ' + error.message);
                    // Fallback: open without origin
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
                    window.open(googleMapsUrl, '_blank');
                });
            } else {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation');
                // Fallback: open without origin
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
                window.open(googleMapsUrl, '_blank');
            }
        }

        function applyFilter() {
            const status = document.getElementById('filter_status').value.trim();
            const type = document.getElementById('filter_type').value.trim();
            const region = document.getElementById('filter_region').value.trim();
            const province = document.getElementById('filter_province').value.trim();
            const district = document.getElementById('filter_district').value.trim();
            const subdistrict = document.getElementById('filter_subdistrict').value.trim();

            const filtered = markers.filter(m => {
                return (!status || (status === '‡πÄ‡∏õ‡∏¥‡∏î' ? m.active : !m.active)) &&
                    (!type || m.shelterType === type) &&
                    (!region || m.region === region) &&
                    (!province || (m.province || '').includes(province)) &&
                    (!district || (m.district || '').includes(district)) &&
                    (!subdistrict || (m.subdistrict || '').includes(subdistrict));
            });

            // ‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô
            markers.forEach(m => {
                if (m.marker) map.Overlays.remove(m.marker);
            });

            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö filter
            filtered.forEach((m, index) => {
                if (m.marker) map.Overlays.add(m.marker);
            });

            clearCapacityBars(); // ‡∏•‡∏ö capacity bar ‡πÄ‡∏î‡∏¥‡∏°

            filtered.forEach((markerData) => {
                if (markerData.capacity && markerData.currentSupport != null) {
                    const bar = createCapacityBar(markerData.lat, markerData.lon, markerData.currentSupport, markerData.capacity);
                    if (bar) capacityBars.push(bar);
                }
            });


            updateMarkersList(filtered);
        }

        function clearFilter() {
            document.getElementById('filter_status').value = '';
            document.getElementById('filter_type').value = '';
            document.getElementById('filter_region').value = '';
            document.getElementById('filter_province').value = '';
            document.getElementById('filter_district').value = '';
            document.getElementById('filter_subdistrict').value = '';

            // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            markers.forEach(m => {
                if (m.marker) map.Overlays.add(m.marker);
            });
            updateMarkersList(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        }

    </script>
    <script>
        function renderUserPanel() {
            const userPanel = document.getElementById("userPanel");
            const username = localStorage.getItem("username");
            const role = localStorage.getItem("userRole");

            if (username && role) {
                // üî§ ‡πÅ‡∏õ‡∏•‡∏á role ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
                const roleNameMap = {
                    admin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                    province: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î',
                    district: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≥‡πÄ‡∏†‡∏≠',
                    local: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡∏ö‡∏•'
                };
                const roleDisplay = roleNameMap[role] || role;

                // üë§ ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡∏õ‡∏∏‡πà‡∏° logout
                userPanel.innerHTML = `
                    <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        üë§ <strong>${username}</strong> (${roleDisplay})
                        <button onclick="logout()" style=" background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; ">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                `;
            } else {
                // üîê ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login
                userPanel.innerHTML = `
                    <button onclick="window.location.href='login.html'" style=" background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; padding: 10px 16px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); ">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                `;
            }
        }

        function logout() {
            localStorage.clear();
            alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
            window.location.reload();
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener("DOMContentLoaded", renderUserPanel);
    </script>

</body>

</html>
