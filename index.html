<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>แผนที่มาร์คจุดพร้อมข้อมูล</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ส่วนแผนที่ (ซ้าย) */
        .map-section {
            flex: 2;
            position: relative;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* เพิ่ม crosshair ตรงกลางจอ */
        .center-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            pointer-events: none;
        }

        .crosshair-h {
            width: 30px;
            height: 2px;
            background: #dc2626;
            position: absolute;
            left: -15px;
            top: -1px;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .crosshair-v {
            width: 2px;
            height: 30px;
            background: #dc2626;
            position: absolute;
            left: -1px;
            top: -15px;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .crosshair-center {
            width: 6px;
            height: 6px;
            background: #dc2626;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            left: -3px;
            top: -3px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 300px;
        }

        /* ส่วนฟอร์ม (ขวา) */
        .form-section {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
            min-width: 350px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 80px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #dc2626;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .btn-form {
            width: 100%;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-form:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-form:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .coordinate-display {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }

        .coordinate-display h4 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .coordinate-text {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .markers-list {
            margin-top: 30px;
        }

        .markers-list h3 {
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .marker-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .marker-item:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .marker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .marker-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .marker-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .marker-capacity {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #9ca3af;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group button {
            flex: 1;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
            vertical-align: middle;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #10b981;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* CSS สำหรับป๊อปอัพแก้ไข */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .edit-modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .edit-modal-header {
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 24px;
            font-weight: 600;
        }

        .edit-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 18px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-modal-close:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .edit-grid {
            display: block;
            margin-top: 20px;
        }

        .edit-form-section {
            overflow-y: auto;
            max-height: 80vh;
            padding-right: 10px;
        }

        /* CSS สำหรับแผนที่ในหน้าแก้ไข */
        .edit-map-container {
            width: 100%;
            height: 300px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .edit-map {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .edit-modal-content {
                width: 98%;
                margin: 10px;
            }

            .edit-map-container {
                height: 250px;
            }
        }
    </style>
    <script type="text/javascript" src="https://api.longdo.com/map3/?key=417740672e7626cdcd09c2756d411dde"></script>
</head>

<body onload="init();">
    <div class="container">
        <div class="map-section">
            <div id="map"></div>
            <div class="center-crosshair">
                <div class="crosshair-h"></div>
                <div class="crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            <div class="status" id="status">
                กำลังเชื่อมต่อ Database...
            </div>
        </div>

        <div class="form-section">
            <div class="form-group" style="display:flex; flex-wrap:wrap; gap:10px;">
                <button type="button" class="btn-form"
                    style="width: 100%; background: linear-gradient(135deg, #3b82f6, #60a5fa);"
                    onclick="openCreateModal()">
                    ➕ เพิ่มศูนย์พักพิงใหม่
                </button>
                <button type="button" class="btn-form"
                    style="background: linear-gradient(135deg, #f59e42, #fbbf24); flex:1;" onclick="drawAllRadii()">
                    ⭕ ดูรัศมีทั้งหมด
                </button>
                <button type="button" class="btn-form"
                    style="background: linear-gradient(135deg, #6b7280, #9ca3af); flex:1;" onclick="clearAllRadii()">
                    🚫 ลบรัศมีทั้งหมด
                </button>
            </div>

            <div class="btn-group">
                <button type="button" class="btn-secondary" onclick="loadMarkersFromFirebase()">
                    🔄 โหลดข้อมูล Database
                </button>
            </div>

            <div class="markers-list">
                <h3>📌 หมุดทั้งหมด (<span id="markerCount">0</span>)</h3>
                <div id="markersList">
                    <div class="empty-state">
                        <p>ยังไม่มีหมุด</p>
                        <p>เลื่อนแผนที่และเพิ่มหมุดแรก!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRCO-wzB0sKIjGXw_IPJGSnjcw00ZBGME",
            authDomain: "testlongdomap.firebaseapp.com",
            projectId: "testlongdomap",
            storageBucket: "testlongdomap.firebaseastorage.app",
            messagingSenderId: "391627017137",
            appId: "1:391627017137:web:8221c2540c136bccaf0b90",
            measurementId: "G-BE75QETT05"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.updateDoc = updateDoc;

        window.addEventListener('load', function () {
            setTimeout(function () {
                updateStatus('✅ Database พร้อมใช้งาน - เลื่อนแผนที่และเพิ่มหมุด', 5000);
                loadMarkersFromFirebase();
            }, 1000);
        });
    </script>

    <script>
        var map;
        var markers = [];
        var currentLat = 13.736717;
        var currentLon = 100.523186;
        var selectedLat = null;
        var selectedLon = null;
        var radiusCircles = [];
        var infoWindowCloseTimeout;
        var statusTimeout;
        var editingIndex = null;
        var editingMarkerData = null;

        function init() {
            try {
                if (typeof longdo === 'undefined' || typeof longdo.Map === 'undefined') {
                    console.log('Longdo Map API not yet loaded. Retrying in 500ms...');
                    updateStatus('กำลังโหลด Longdo Map API...', 500);
                    setTimeout(init, 500);
                    return;
                }
                console.log('Longdo Map API loaded successfully. Initializing map...');

                map = new longdo.Map({
                    placeholder: document.getElementById('map'),
                    language: 'th'
                });

                map.location({ lon: currentLon, lat: currentLat });
                map.zoom(6);

                map.Event.bind('location', updateCurrentCoordinate);
                updateCurrentCoordinate();
                updateStatus('กำลังเตรียมแผนที่...', 5000);
            } catch (error) {
                console.error('Error in init function:', error);
                updateStatus('เกิดข้อผิดพลาดในการโหลดแผนที่: ' + error.message, 5000);
            }
        }

        function updateCurrentCoordinate() {
            try {
                var centerLocation = map.location();
                if (centerLocation) {
                    currentLat = centerLocation.lat;
                    currentLon = centerLocation.lon;
                    var coordElem = document.getElementById('currentCoordinate');
                    if (coordElem) {
                        coordElem.innerHTML =
                            'ละติจูด: ' + currentLat.toFixed(6) + '<br>' +
                            'ลองจิจูด: ' + currentLon.toFixed(6);
                    }
                }
            } catch (error) {
                console.error('Error updating coordinates:', error);
            }
        }

        // ฟังก์ชันช่วยในการกำหนดระดับการซูมตามขนาดรัศมี (สำหรับ 10 กม. หรือภาพรวม)
        function getZoomLevelForRadius(radiusInMeters) {
            if (radiusInMeters <= 1000) return 15; // 1km or less
            if (radiusInMeters <= 3000) return 14; // 3km
            if (radiusInMeters <= 5000) return 13; // 5km
            if (radiusInMeters <= 10000) return 12; // 10km (ซูมเข้าให้เห็นภาพทั้งหมด 10 กม.)
            if (radiusInMeters <= 20000) return 11; // 20km
            return 10; // Default for larger radii
        }

        // ฟังก์ชันสำหรับดูรัศมีทั้งหมด
        function drawAllRadii() {
            try {
                // ลบวงกลมรัศมีเดิมทั้งหมด
                radiusCircles.forEach(circle => map.Overlays.remove(circle));
                radiusCircles = [];

                var center = map.location(); // จุดกึ่งกลางของแผนที่ปัจจุบัน

                // ข้อมูลรัศมีและสี
                const radii = [
                    { size: 10000, stroke: 'rgba(255, 190, 0, 1.0)', fill: 'rgba(255, 215, 0, 0.2)', title: 'รัศมี 10 กม. (ส้มอ่อนที่สุด)' }, // 10 กม. ส้มอ่อนที่สุด
                    { size: 5000, stroke: 'rgba(255, 165, 0, 1.0)', fill: 'rgba(255, 190, 0, 0.4)', title: 'รัศมี 5 กม. (ส้มกลาง)' },    // 5 กม. ส้มกลาง
                    { size: 3000, stroke: 'rgba(255, 140, 0, 1.0)', fill: 'rgba(255, 165, 0, 0.6)', title: 'รัศมี 3 กม. (ส้มเข้มที่สุด)' }  // 3 กม. ส้มเข้มที่สุด
                ];

                // วาดวงกลมรัศมีจากวงใหญ่ไปวงเล็ก เพื่อให้ซ้อนทับกันได้ถูกต้อง (วงเล็กอยู่บนสุด)
                radii.forEach(r => {
                    var radiusInDegrees = r.size / longdo.Util.longitudeLength(center.lat);
                    var circleOptions = {
                        fillColor: r.fill,
                        strokeColor: r.stroke,
                        strokeWidth: 3,
                        title: r.title
                    };
                    var circle = new longdo.Circle(center, radiusInDegrees, circleOptions);
                    map.Overlays.add(circle);
                    radiusCircles.push(circle);
                });

                // ซูมไปที่ระดับที่เหมาะสมกับรัศมี 10 กม. และเลื่อนไปยังจุดกึ่งกลาง
                map.location(center, true);
                map.zoom(getZoomLevelForRadius(10000), true); // ซูมให้เห็น 10 กม.

                updateStatus(`⭕ แสดงรัศมี 3, 5, และ 10 กม. ที่พิกัด ${center.lat.toFixed(6)}, ${center.lon.toFixed(6)}`, 5000);
            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการสร้างรัศมี: ' + error.message, 5000);
                console.error('Error drawing circles:', error);
            }
        }

        // ฟังก์ชันสำหรับลบรัศมีทั้งหมด
        function clearAllRadii() {
            try {
                radiusCircles.forEach(circle => map.Overlays.remove(circle));
                radiusCircles = []; // ล้าง array หลังจากลบทั้งหมด
                updateStatus('🚫 ลบรัศมีทั้งหมดออกจากแผนที่แล้ว', 5000);
            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการลบรัศมี: ' + error.message, 5000);
            }
        }

        function createMarker(lat, lon, name, address, active, capacity, markerId, markerIndex, extraData = {}) {
            let detail = `
                <div style="padding: 10px; font-size: 14px; line-height: 1.6;">
                    <table style="width: 100%; border-collapse: collapse;">
                        ${extraData.shelterType ? `<tr><td style="padding: 4px 0; vertical-align: top; width: 35%;">🏢 <b>ประเภทศูนย์:</b></td><td style="padding: 4px 0; vertical-align: top; width: 65%;">${extraData.shelterType}</td></tr>` : ''}
                        ${name ? `<tr><td style="padding: 4px 0; vertical-align: top;">👤 <b>ชื่อ-สกุล:</b></td><td style="padding: 4px 0; vertical-align: top;">${name}</td></tr>` : ''}
                        ${extraData.phone ? `<tr><td style="padding: 4px 0; vertical-align: top;">📞 <b>โทร:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.phone}</td></tr>` : ''}
                        ${extraData.region ? `<tr><td style="padding: 4px 0; vertical-align: top;">🗺️ <b>ภาค:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.region}</td></tr>` : ''}
                        ${extraData.province ? `<tr><td style="padding: 4px 0; vertical-align: top;"><b>จังหวัด:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.province}</td></tr>` : ''}
                        ${extraData.district ? `<tr><td style="padding: 4px 0; vertical-align: top;"><b>อำเภอ:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.district}</td></tr>` : ''}
                        ${extraData.subdistrict ? `<tr><td style="padding: 4px 0; vertical-align: top;"><b>ตำบล:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.subdistrict}</td></tr>` : ''}
                        ${extraData.village ? `<tr><td style="padding: 4px 0; vertical-align: top;"><b>หมู่บ้าน:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.village}</td></tr>` : ''}
                        ${extraData.zipcode ? `<tr><td style="padding: 4px 0; vertical-align: top;"><b>รหัสไปรษณีย์:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.zipcode}</td></tr>` : ''}
                        ${address ? `<tr><td style="padding: 4px 0; vertical-align: top;">📍 <b>สถานที่:</b></td><td style="padding: 4px 0; vertical-align: top;">${address}</td></tr>` : ''}
                        <tr><td style="padding: 4px 0; vertical-align: top;">🌍 <b>พิกัด:</b></td><td style="padding: 4px 0; vertical-align: top;">${lat.toFixed(6)}, ${lon.toFixed(6)}</td></tr>
                        ${capacity !== null && capacity !== undefined ? `<tr><td style="padding: 4px 0; vertical-align: top;">👥 <b>รองรับ:</b></td><td style="padding: 4px 0; vertical-align: top;">${capacity.toLocaleString()} คน</td></tr>` : ''}
                        ${extraData.currentSupport !== null && extraData.currentSupport !== undefined ? `<tr><td style="padding: 4px 0; vertical-align: top;">👤 <b>ผู้พักพิง:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.currentSupport} คน</td></tr>` : ''}
                        ${extraData.parking ? `<tr><td style="padding: 4px 0; vertical-align: top;">🚗 <b>ที่จอดรถ:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.parking} คัน</td></tr>` : ''}
                        ${extraData.toilet ? `<tr><td style="padding: 4px 0; vertical-align: top;">🚻 <b>สุขา:</b></td><td style="padding: 4px 0; vertical-align: top;">${extraData.toilet}</td></tr>` : ''}
                    </table>
                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${extraData.electricity === 'มี' ? `<span style="background: #e0f7fa; color: #00796b; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block;">⚡ ไฟฟ้า</span>` : ''}
                        ${extraData.water === 'มี' ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block;">💧 ประปา</span>` : ''}
                        ${extraData.wifi === 'มี' ? `<span style="background: #ede7f6; color: #4527a0; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block;">📶 Wifi</span>` : ''}
                        ${extraData.pet === 'มี' ? `<span style="background: #ffe0b2; color: #e65100; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block;">🐶 รองรับสัตว์เลี้ยง</span>` : ''}
                        ${extraData.tent === 'มี' ? `<span style="background: #c8e6c9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block;">⛺ กางเต็นท์</span>` : ''}
                    </div>
                </div>
            `;
            // เพิ่ม toggle เปิด/ปิด
            if (typeof markerId !== 'undefined' && typeof markerIndex !== 'undefined') {
                detail += `
                    <div style='margin:12px 0;'>
                        <label class="switch">
                            <input type="checkbox" ${active ? 'checked' : ''} onchange="toggleActive('${markerId}', ${markerIndex}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style='margin-left:8px; vertical-align: middle; font-weight: 600; color: ${active ? '#10b981' : '#dc2626'};'>${active ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                        <button onclick="editMarkerFromPopup('${markerId}', ${markerIndex})" style="background:#3b82f6;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;font-size:13px;font-weight:600;">✏️ แก้ไข</button>
                        <button onclick="deleteMarkerFromPopup('${markerId}', ${markerIndex})" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;font-size:13px;font-weight:600;">🗑️ ลบหมุดนี้</button>
                        <button onclick="getDirections(${lat}, ${lon})" style="background:#10b981;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;flex:1;min-width:100px;font-size:13px;font-weight:600;">🗺️ เส้นทาง</button>
                    </div>
                </div>
                `;
            }

            const markerOptions = {
                title: name,
                detail: detail,
                // กำหนดขนาดของ Popup โดยตรง
                size: { width: 450, height: 'auto' } // กำหนด width เป็น 450px, height เป็น auto
            };

            if (active) {
                markerOptions.icon = { url: 'greenMarker.png', offset: { x: 0, y: -18 }, size: { w: 32, h: 32 } };
            } else {
                markerOptions.icon = {
                    url: 'redMarker.png', // สมมติว่าคุณมีไอคอนสีแดงสำหรับสถานะ 'ปิด'
                    offset: { x: 0, y: -18 }, size: { w: 32, h: 32 }
                };
            }

            const marker = new longdo.Marker(
                { lon: lon, lat: lat },
                markerOptions
            );

            // เพิ่ม event hover เพื่อแสดง/ปิดป๊อปอัพ
            if (marker && marker.Event && typeof marker.Event.bind === 'function') {
                marker.Event.bind('OverlayHover', function () {
                    // console.log('OverlayHover fired for marker:', name, 'ID:', markerId);
                    if (infoWindowCloseTimeout) {
                        clearTimeout(infoWindowCloseTimeout);
                        infoWindowCloseTimeout = null;
                    }
                    map.InfoWindow.open(marker);
                });

                marker.Event.bind('OverlayLeave', function () {
                    // console.log('OverlayLeave fired for marker:', name, 'ID:', markerId);
                    if (infoWindowCloseTimeout) {
                        clearTimeout(infoWindowCloseTimeout);
                    }
                    infoWindowCloseTimeout = setTimeout(() => {
                        map.InfoWindow.close();
                    }, 300);
                });

                // ทิ้ง Event 'click' ไว้เพื่อเปรียบเทียบว่ายังทำงานปกติหรือไม่
                marker.Event.bind('click', function () {
                    // console.log('Click event fired for marker:', name, 'ID:', markerId);
                    map.InfoWindow.open(marker);
                });
            }
            return marker;
        }

        async function addMarkerWithData() {
            try {
                // ดึงค่าทุกฟิลด์จากฟอร์ม
                var shelterType = document.getElementById('edit_shelterType').value;
                if (!["ตามแผน", "นอกแผน", "อื่นๆ"].includes(shelterType)) shelterType = '';
                var name = document.getElementById('edit_fullName').value.trim();
                var phone = document.getElementById('edit_phone').value.trim();
                var region = document.getElementById('edit_region').value;
                var province = document.getElementById('edit_province').value.trim();
                var district = document.getElementById('edit_district').value.trim();
                var subdistrict = document.getElementById('edit_subdistrict').value.trim();
                var village = document.getElementById('edit_village').value.trim();
                var zipcode = document.getElementById('edit_zipcode').value.trim();
                var place = document.getElementById('edit_place').value.trim();
                var lat = document.getElementById('edit_lat').value;
                var lon = document.getElementById('edit_lon').value;
                var electricity = document.getElementById('edit_electricity').value;
                var water = document.getElementById('edit_water').value;
                var wifi = document.getElementById('edit_wifi').value;
                var pet = document.getElementById('edit_pet').value;
                var tent = document.getElementById('edit_tent').value;
                var toilet = document.getElementById('edit_toilet').value.trim();
                var parking = document.getElementById('edit_parking').value.trim();
                var canSupport = document.getElementById('edit_canSupport').value;
                var currentSupport = document.getElementById('edit_currentSupport').value;
                var status = document.getElementById('edit_status').value;
                if (!status) status = 'เปิด';
                var active = (status === 'เปิด');

                if (!name) {
                    alert('กรุณากรอกชื่อ-สกุล');
                    return;
                }

                var addBtn = document.getElementById('addMarkerBtn');
                var originalText = addBtn.textContent;
                addBtn.textContent = '💾 กำลังบันทึก...';
                addBtn.disabled = true;

                var markerData = {
                    shelterType: shelterType || '',
                    name: name,
                    phone: phone || '',
                    region: region || '',
                    province: province || '',
                    district: district || '',
                    subdistrict: subdistrict || '',
                    village: village || '',
                    zipcode: zipcode || '',
                    address: place || '',
                    lat: lat ? parseFloat(lat) : currentLat,
                    lon: lon ? parseFloat(lon) : currentLon,
                    electricity: electricity || '',
                    water: water || '',
                    wifi: wifi || '',
                    pet: pet || '',
                    tent: tent || '',
                    toilet: toilet || '',
                    parking: parking || '',
                    capacity: canSupport ? parseInt(canSupport) : null,
                    currentSupport: currentSupport ? parseInt(currentSupport) : null,
                    active: active,
                    createdAt: new Date(),
                    timestamp: Date.now(),
                };

                // Save to Firebase Firestore
                const docRef = await window.addDoc(window.collection(window.db, "markers"), markerData);

                // Add marker to map
                var marker = createMarker(markerData.lat, markerData.lon, name, place, false, markerData.capacity, docRef.id, markers.length, markerData); // ใช้ docRef.id ที่ถูกต้อง
                map.Overlays.add(marker);

                markerData.id = docRef.id;
                markerData.marker = marker;
                markerData.createdAt = markerData.createdAt.toLocaleString('th-TH');
                markers.push(markerData);
                updateMarkersList();
                clearForm();
                updateStatus('✅ บันทึก "' + name + '" ใน Database สำเร็จ!', 5000);

                addBtn.textContent = originalText;
                addBtn.disabled = false;

            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการบันทึก: ' + error.message, 5000);
                var addBtn = document.getElementById('addMarkerBtn');
                addBtn.textContent = originalText;
                addBtn.disabled = false;
                console.error('Error adding marker with data:', error);
            }
        }

        async function loadMarkersFromFirebase() {
            try {
                updateStatus('🔄 กำลังโหลดข้อมูลจาก Database...', 0);
                markers.forEach(markerData => {
                    if (markerData.marker) {
                        map.Overlays.remove(markerData.marker);
                    }
                });
                markers = []; // Clear local markers array

                const markersCol = window.collection(window.db, 'markers');
                const q = window.query(markersCol, window.orderBy('timestamp', 'desc'));
                const querySnapshot = await window.getDocs(q);

                if (querySnapshot.empty) {
                    updateStatus('ℹ️ ไม่พบข้อมูลหมุดใน Database', 5000);
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const marker = createMarker(data.lat, data.lon, data.name, data.address, data.active, data.capacity, doc.id, markers.length, data);
                        map.Overlays.add(marker);

                        // Store marker with its ID and original data
                        markers.push({
                            id: doc.id,
                            marker: marker,
                            ...data
                        });
                    });
                    updateStatus(`✅ โหลดข้อมูลหมุด ${markers.length} จุดจาก Database สำเร็จ!`, 5000);
                }
                updateMarkersList();
            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 5000);
                console.error('Error loading markers from Firebase:', error);
            }
        }

        function updateMarkersList() {
            var markersListDiv = document.getElementById('markersList');
            var markerCountSpan = document.getElementById('markerCount');
            markersListDiv.innerHTML = ''; // Clear current list
            markerCountSpan.textContent = markers.length;

            if (markers.length === 0) {
                markersListDiv.innerHTML = `
                    <div class="empty-state">
                        <p>ยังไม่มีหมุด</p>
                        <p>เลื่อนแผนที่และเพิ่มหมุดแรก!</p>
                    </div>
                `;
                return;
            }

            // Sort markers by creation timestamp (latest first)
            const sortedMarkers = [...markers].sort((a, b) => b.timestamp - a.timestamp);

            sortedMarkers.forEach((markerData, index) => {
                var markerItem = document.createElement('div');
                markerItem.className = 'marker-item';
                markerItem.setAttribute('data-id', markerData.id);
                markerItem.innerHTML = `
                    <div class="marker-header">
                        <div style="flex-grow: 1;">
                            <div class="marker-name">${markerData.name}</div>
                            <div class="marker-details">
                                ${markerData.subdistrict || ''} ${markerData.district || ''} ${markerData.province || ''} ${markerData.zipcode || ''}<br>
                                พิกัด: ${markerData.lat.toFixed(6)}, ${markerData.lon.toFixed(6)}<br>
                                รองรับ: ${markerData.capacity !== null && markerData.capacity !== undefined ? markerData.capacity.toLocaleString() : 'N/A'} คน (ปัจจุบัน: ${markerData.currentSupport !== null && markerData.currentSupport !== undefined ? markerData.currentSupport.toLocaleString() : 'N/A'} คน)<br>
                                เพิ่มเมื่อ: ${markerData.createdAt}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" ${markerData.active ? 'checked' : ''} onchange="toggleActive('${markerData.id}', ${index}, this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span style='font-weight: 600; color: ${markerData.active ? '#10b981' : '#dc2626'};'>${markerData.active ? 'เปิด' : 'ปิด'}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                        ${markerData.electricity === 'มี' ? `<span style="background: #e0f7fa; color: #00796b; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">⚡ ไฟฟ้า</span>` : ''}
                        ${markerData.water === 'มี' ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">💧 ประปา</span>` : ''}
                        ${markerData.wifi === 'มี' ? `<span style="background: #ede7f6; color: #4527a0; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">📶 Wifi</span>` : ''}
                        ${markerData.pet === 'มี' ? `<span style="background: #ffe0b2; color: #e65100; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">🐶 สัตว์เลี้ยง</span>` : ''}
                        ${markerData.tent === 'มี' ? `<span style="background: #c8e6c9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">⛺ กางเต็นท์</span>` : ''}
                        ${markerData.parking ? `<span style="background: #fff3e0; color: #ff6f00; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">🅿️ ที่จอดรถ: ${markerData.parking}</span>` : ''}
                        ${markerData.toilet ? `<span style="background: #fce4ec; color: #ad1457; padding: 4px 8px; border-radius: 4px; font-size: 11px; display: inline-block;">🚻 สุขา: ${markerData.toilet}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn-secondary" style="flex:1;" onclick="map.location({ lat: ${markerData.lat}, lon: ${markerData.lon} }, true, 16);">ดูบนแผนที่</button>
                        <button class="btn-secondary" style="background-color: #3b82f6; flex:1;" onclick="editMarkerFromPopup('${markerData.id}', ${index})">แก้ไข</button>
                        <button class="btn-secondary" style="background-color: #10b981; flex:1;" onclick="getDirections(${markerData.lat}, ${markerData.lon})">เส้นทาง</button>
                        <button class="btn-secondary" style="background-color: #ef4444; flex:1;" onclick="deleteMarker('${markerData.id}', ${index})">ลบ</button>
                    </div>
                `;
                markersListDiv.appendChild(markerItem);
            });
        }

        async function deleteMarker(markerId, index) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบหมุดนี้?')) {
                try {
                    updateStatus(`🗑️ กำลังลบหมุด ID: ${markerId}...`, 0);
                    await window.deleteDoc(window.doc(window.db, 'markers', markerId));
                    // Remove from map
                    if (markers[index] && markers[index].marker) {
                        map.Overlays.remove(markers[index].marker);
                    }
                    // Remove from local array
                    markers.splice(index, 1);
                    updateMarkersList();
                    updateStatus('✅ ลบหมุดสำเร็จ!', 5000);
                } catch (error) {
                    updateStatus('❌ เกิดข้อผิดพลาดในการลบหมุด: ' + error.message, 5000);
                    console.error('Error deleting marker:', error);
                }
            }
        }

        async function toggleActive(markerId, index, newStatus) {
            try {
                updateStatus(`🔄 กำลังอัปเดตสถานะหมุด ID: ${markerId}...`, 0);
                const markerRef = window.doc(window.db, 'markers', markerId);
                await window.updateDoc(markerRef, {
                    active: newStatus
                });

                // Update local array and map marker
                if (markers[index]) {
                    markers[index].active = newStatus;
                    // Remove old marker
                    map.Overlays.remove(markers[index].marker);
                    // Create new marker with updated active status
                    markers[index].marker = createMarker(markers[index].lat, markers[index].lon, markers[index].name, markers[index].address, newStatus, markers[index].capacity, markers[index].id, index, markers[index]);
                    map.Overlays.add(markers[index].marker);
                }
                updateMarkersList();
                updateStatus('✅ อัปเดตสถานะหมุดสำเร็จ!', 5000);
            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการอัปเดตสถานะ: ' + error.message, 5000);
                console.error('Error updating marker status:', error);
            }
        }

        async function updateMarker(markerId, index) {
            try {
                var shelterType = document.getElementById('shelterType').value;
                if (!["ตามแผน", "นอกแผน", "อื่นๆ"].includes(shelterType)) shelterType = '';
                var name = document.getElementById('fullName').value.trim();
                var phone = document.getElementById('phone').value.trim();
                var region = document.getElementById('region').value;
                var province = document.getElementById('province').value.trim();
                var district = document.getElementById('district').value.trim();
                var subdistrict = document.getElementById('subdistrict').value.trim();
                var village = document.getElementById('village').value.trim();
                var zipcode = document.getElementById('zipcode').value.trim();
                var place = document.getElementById('place').value.trim();
                var lat = document.getElementById('lat').value;
                var lon = document.getElementById('lon').value;
                var electricity = document.getElementById('electricity').value;
                var water = document.getElementById('water').value;
                var wifi = document.getElementById('wifi').value;
                var pet = document.getElementById('pet').value;
                var tent = document.getElementById('tent').value;
                var toilet = document.getElementById('toilet').value.trim();
                var parking = document.getElementById('parking').value.trim();
                var canSupport = document.getElementById('canSupport').value;
                var currentSupport = document.getElementById('currentSupport').value;
                var status = document.getElementById('status').value;
                if (!status) status = 'เปิด';
                var active = (status === 'เปิด');

                if (!name) {
                    alert('กรุณากรอกชื่อ-สกุล');
                    return;
                }

                var updateBtn = document.getElementById('addMarkerBtn');
                var originalText = updateBtn.textContent;
                updateBtn.textContent = '💾 กำลังอัปเดต...';
                updateBtn.disabled = true;

                const updatedData = {
                    shelterType: shelterType || '',
                    name: name,
                    phone: phone || '',
                    region: region || '',
                    province: province || '',
                    district: district || '',
                    subdistrict: subdistrict || '',
                    village: village || '',
                    zipcode: zipcode || '',
                    address: place || '',
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    electricity: electricity || '',
                    water: water || '',
                    wifi: wifi || '',
                    pet: pet || '',
                    tent: tent || '',
                    toilet: toilet || '',
                    parking: parking || '',
                    capacity: canSupport ? parseInt(canSupport) : null,
                    currentSupport: currentSupport ? parseInt(currentSupport) : null,
                    active: active,
                    updatedAt: new Date(),
                };

                const markerRef = window.doc(window.db, 'markers', markerId);
                await window.updateDoc(markerRef, updatedData);

                // Update local array
                const markerIndex = markers.findIndex(m => m.id === markerId);
                if (markerIndex !== -1) {
                    // Remove old marker from map
                    if (markers[markerIndex] && markers[markerIndex].marker) {
                        map.Overlays.remove(markers[markerIndex].marker);
                    }
                    // Create new marker with updated data
                    const newMarker = createMarker(updatedData.lat, updatedData.lon, updatedData.name, updatedData.address, updatedData.active, updatedData.capacity, markerId, markerIndex, updatedData);
                    map.Overlays.add(newMarker);

                    markers[markerIndex] = {
                        id: markerId,
                        marker: newMarker,
                        ...updatedData,
                        createdAt: markers[markerIndex].createdAt, // Keep original creation date
                        timestamp: markers[markerIndex].timestamp // Keep original timestamp
                    };
                    markers[markerIndex].updatedAt = new Date().toLocaleString('th-TH');
                }

                updateMarkersList();
                clearForm();
                updateStatus('✅ อัปเดต "' + name + '" สำเร็จ!', 5000);

                // Reset form button to add mode
                updateBtn.textContent = '✅ เพิ่มหมุดพร้อมข้อมูล';
                updateBtn.onclick = function () {
                    addMarkerWithData();
                };
                updateBtn.style.background = 'linear-gradient(135deg, #059669, #10b981)'; // Green gradient
                updateBtn.disabled = false;

            } catch (error) {
                updateStatus('❌ เกิดข้อผิดพลาดในการอัปเดต: ' + error.message, 5000);
                var updateBtn = document.getElementById('addMarkerBtn');
                updateBtn.textContent = originalText;
                updateBtn.disabled = false;
                console.error('Error updating marker:', error);
            }
        }

        function editMarkerFromPopup(markerId, index) {
            if (map && map.InfoWindow && typeof map.InfoWindow.close === 'function') {
                map.InfoWindow.close();
            }
            const markerData = markers.find(m => m.id === markerId);
            if (!markerData) return;
            openEditModal(markerData, index);
        }

        function openEditModal(markerData, index) {
            editingIndex = index;
            editingMarkerData = markerData;

            // ใส่ข้อมูลเดิมลงในฟอร์มแก้ไข
            document.getElementById('edit_shelterType').value = markerData.shelterType || '';
            document.getElementById('edit_fullName').value = markerData.name || '';
            document.getElementById('edit_phone').value = markerData.phone || '';
            document.getElementById('edit_region').value = markerData.region || '';
            document.getElementById('edit_province').value = markerData.province || '';
            document.getElementById('edit_district').value = markerData.district || '';
            document.getElementById('edit_subdistrict').value = markerData.subdistrict || '';
            document.getElementById('edit_village').value = markerData.village || '';
            document.getElementById('edit_zipcode').value = markerData.zipcode || '';
            document.getElementById('edit_place').value = markerData.address || '';
            document.getElementById('edit_lat').value = markerData.lat || '';
            document.getElementById('edit_lon').value = markerData.lon || '';
            document.getElementById('edit_electricity').value = markerData.electricity || 'ไม่มี';
            document.getElementById('edit_water').value = markerData.water || 'ไม่มี';
            document.getElementById('edit_wifi').value = markerData.wifi || 'ไม่มี';
            document.getElementById('edit_pet').value = markerData.pet || 'ไม่มี';
            document.getElementById('edit_tent').value = markerData.tent || 'ไม่มี';
            document.getElementById('edit_toilet').value = markerData.toilet || '';
            document.getElementById('edit_parking').value = markerData.parking || '';
            document.getElementById('edit_canSupport').value = markerData.capacity || '';
            document.getElementById('edit_currentSupport').value = markerData.currentSupport || '';
            document.getElementById('edit_status').value = markerData.active ? 'เปิด' : 'ปิด';

            // เปลี่ยนหัวข้อ popup เป็นโหมดแก้ไข
            document.querySelector('.edit-modal-header').textContent = '✏️ แก้ไขข้อมูลศูนย์พักพิง';

            // ปุ่มบันทึกเป็นโหมดแก้ไข
            const saveBtn = document.querySelector('#editMarkerForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.textContent = '💾 บันทึกการแก้ไข';
            }

            // เปิด modal
            document.getElementById('editModal').classList.add('edit-modal');
            document.getElementById('editModal').style.display = 'flex';

            // เปิดแผนที่แก้ไขที่พิกัดเดิม
            setTimeout(() => {
        const editMapContainer = document.getElementById('editMap');
        if (editMapContainer && editMapContainer.offsetWidth > 0) {
            const lat = parseFloat(markerData.lat);
            const lon = parseFloat(markerData.lon);
            if (!isNaN(lat) && !isNaN(lon)) {
                initEditMap(lat, lon);
            }
        } else {
            // ลองใหม่หลัง 500ms
            setTimeout(() => initEditMap(parseFloat(markerData.lat), parseFloat(markerData.lon)), 500);
        }
    }, 300);
}

        function openCreateModal() {
            editingIndex = null;
            editingMarkerData = null;

            // ล้างค่าทุก input ใน modal
            const fields = [
                'edit_shelterType', 'edit_fullName', 'edit_phone', 'edit_region', 'edit_province',
                'edit_district', 'edit_subdistrict', 'edit_village', 'edit_zipcode', 'edit_place',
                'edit_lat', 'edit_lon', 'edit_electricity', 'edit_water', 'edit_wifi', 'edit_pet',
                'edit_tent', 'edit_toilet', 'edit_parking', 'edit_canSupport', 'edit_currentSupport', 'edit_status'
            ];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'SELECT') el.selectedIndex = 0;
                    else el.value = '';
                }
            });

            // เปลี่ยนหัวข้อ popup ให้เป็น เพิ่มศูนย์พักพิงใหม่
            document.querySelector('.edit-modal-header').textContent = '➕ เพิ่มศูนย์พักพิงใหม่';

            // เปลี่ยนปุ่มบันทึกให้เป็นโหมดสร้างใหม่
            const saveBtn = document.querySelector('#editMarkerForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.textContent = '✅ สร้างศูนย์พักพิงใหม่';
                saveBtn.id = 'addMarkerBtn'; // เพิ่มบรรทัดนี้เพื่อตั้งค่า id
            }

            // เปิด modal
            document.getElementById('editModal').classList.add('edit-modal');
            document.getElementById('editModal').style.display = 'flex';

            // เซ็ตแผนที่เริ่มต้นที่ตำแหน่งกึ่งกลาง map หลัก
            setTimeout(() => {
                const center = map.location();
                initEditMap(center.lat, center.lon);
            }, 300);
        }

        // ตัวแปรสำหรับแผนที่แก้ไข
        var editMap = null;
        var editCurrentMarker = null;

        // ฟังก์ชัน initEditMap ที่แก้ไขแล้ว
function initEditMap(lat, lon) {
    try {
        console.log('Initializing edit map at coordinates:', lat, lon);

        // ตรวจสอบว่า longdo API พร้อมใช้งาน
        if (typeof longdo === 'undefined' || !longdo.Map) {
            console.error('Longdo Map API not loaded yet');
            // ลองใหม่หลัง 1 วินาที
            setTimeout(() => initEditMap(lat, lon), 1000);
            return;
        }

        const editMapContainer = document.getElementById('editMap');
        if (!editMapContainer) {
            console.error('Edit map container not found');
            return;
        }

        // ตรวจสอบว่า container มีขนาดที่เหมาะสม
        if (editMapContainer.offsetWidth === 0 || editMapContainer.offsetHeight === 0) {
            console.warn('Edit map container has no dimensions, retrying...');
            setTimeout(() => initEditMap(lat, lon), 500);
            return;
        }

        // ลบแผนที่เก่าถ้ามี
        if (editMap) {
            try {
                editMap.destroy();
            } catch (e) {
                console.warn('Could not destroy previous edit map:', e);
            }
            editMap = null;
        }

        // สร้างแผนที่ใหม่พร้อมการตั้งค่าที่ปลอดภัย
        editMap = new longdo.Map({
            placeholder: editMapContainer,
            language: 'th'
        });

        // รอให้แผนที่โหลดเสร็จก่อนตั้งค่าตำแหน่ง
        setTimeout(() => {
            try {
                if (editMap && typeof editMap.location === 'function') {
                    editMap.location({ lon: lon, lat: lat });
                    editMap.zoom(15);

                    // เพิ่ม marker ที่ตำแหน่งเดิม
                    if (editCurrentMarker) {
                        try {
                            editMap.Overlays.remove(editCurrentMarker);
                        } catch (e) {
                            console.warn('Could not remove previous marker:', e);
                        }
                    }

                    editCurrentMarker = new longdo.Marker({ lon: lon, lat: lat }, {
                        title: 'ตำแหน่งปัจจุบัน',
                        detail: 'คลิกเพื่อเลือกตำแหน่งใหม่',
                        icon: {
                            url: 'https://api.longdo.com/mmmap/images/pin_mark.png',
                            offset: { x: 12, y: 45 }
                        }
                    });

                    editMap.Overlays.add(editCurrentMarker);

                    // เพิ่ม event listener สำหรับการคลิกบนแผนที่
                    editMap.Event.bind('click', function (location) {
                        try {
                            if (editCurrentMarker && location) {
                                // ย้าย marker ไปยังตำแหน่งใหม่
                                editCurrentMarker.location({ lon: location.lon, lat: location.lat });

                                // อัปเดตค่าใน input fields
                                const latInput = document.getElementById('edit_lat');
                                const lonInput = document.getElementById('edit_lon');
                                
                                if (latInput) latInput.value = location.lat.toFixed(6);
                                if (lonInput) lonInput.value = location.lon.toFixed(6);

                                console.log('Marker moved to:', location.lat.toFixed(6), location.lon.toFixed(6));
                                updateStatus(`📍 เลือกตำแหน่งใหม่: ${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}`, 3000);
                            }
                        } catch (clickError) {
                            console.error('Error handling map click:', clickError);
                        }
                    });

                    console.log('Edit map initialized successfully');
                    updateStatus('✅ แผนที่แก้ไขพร้อมใช้งาน', 3000);
                }
            } catch (setupError) {
                console.error('Error setting up edit map:', setupError);
                updateStatus('❌ เกิดข้อผิดพลาดในการตั้งค่าแผนที่แก้ไข', 3000);
            }
        }, 500);

    } catch (error) {
        console.error('Error initializing edit map:', error);
        updateStatus('❌ เกิดข้อผิดพลาดในการสร้างแผนที่แก้ไข', 3000);
        
        // ลองใหม่อีกครั้งหลัง 2 วินาที
        setTimeout(() => {
            console.log('Retrying edit map initialization...');
            initEditMap(lat, lon);
        }, 2000);
    }
}

        async function fetchAddressForEdit(lat, lon) {
            try {
                console.log('fetchAddressForEdit called with:', lat, lon); // Debug

                const apiKey = '417740672e7626cdcd09c2756d411dde';
                const url = `https://api.longdo.com/map/services/address?lon=${lon}&lat=${lat}&noelevation=1&locale=th&key=${apiKey}`;
                console.log('API URL:', url); // Debug

                const response = await fetch(url);
                const result = await response.json();
                console.log('API Response:', result); // Debug

                if (result) {
                    const cleanPrefix = (text) => {
                        if (text && typeof text === 'string') {
                            if (text.startsWith('จ.')) return text.substring(2).trim();
                            else if (text.startsWith('อ.')) return text.substring(2).trim();
                            else if (text.startsWith('ต.')) return text.substring(2).trim();
                            else if (text.startsWith('เขต')) return text.substring(3).trim();
                            else if (text.startsWith('แขวง')) return text.substring(4).trim();
                        }
                        return text || '';
                    };

                    // จังหวัด/อำเภอ/ตำบล/รหัสไปรษณีย์
                    const provinceName = cleanPrefix(result.province);

                    // เช็คว่า element มีอยู่จริงหรือไม่
                    const elements = {
                        subdistrict: document.getElementById('edit_subdistrict'),
                        district: document.getElementById('edit_district'),
                        province: document.getElementById('edit_province'),
                        zipcode: document.getElementById('edit_zipcode'),
                        region: document.getElementById('edit_region')
                    };

                    console.log('Form elements found:', elements); // Debug

                    if (elements.subdistrict) elements.subdistrict.value = cleanPrefix(result.subdistrict);
                    if (elements.district) elements.district.value = cleanPrefix(result.district);
                    if (elements.province) elements.province.value = provinceName;
                    if (elements.zipcode) elements.zipcode.value = result.postcode || '';

                    // เซ็ตภาคตามจังหวัด
                    const regionMap = {
                        'เหนือ': ['เชียงใหม่', 'เชียงราย', 'ลำปาง', 'ลำพูน', 'แพร่', 'น่าน', 'พะเยา', 'แม่ฮ่องสอน', 'ตาก', 'กำแพงเพชร', 'สุโขทัย', 'พิษณุโลก', 'พิจิตร', 'เพชรบูรณ์', 'อุตรดิตถ์'],
                        'กลาง': ['กรุงเทพมหานคร', 'นนทบุรี', 'ปทุมธานี', 'สมุทรปราการ', 'นครปฐม', 'สมุทรสาคร', 'อ่างทอง', 'ลพบุรี', 'สิงห์บุรี', 'ชัยนาท', 'สระบุรี', 'พระนครศรีอยุธยา', 'สุพรรณบุรี'],
                        'ตะวันออก': ['ชลบุรี', 'ระยอง', 'จันทบุรี', 'ตราด', 'สระแก้ว', 'ปราจีนบุรี', 'นครนายก'],
                        'ตะวันตก': ['กาญจนบุรี', 'ราชบุรี', 'เพชรบุรี', 'ประจวบคีรีขันธ์'],
                        'ตะวันออกเฉียงเหนือ': ['นครราชสีมา', 'ขอนแก่น', 'อุดรธานี', 'อุบลราชธานี', 'ศรีสะเกษ', 'สุรินทร์', 'บุรีรัมย์', 'มหาสารคาม', 'ร้อยเอ็ด', 'ยโสธร', 'นครพนม', 'สกลนคร', 'มุกดาหาร', 'กาฬสินธุ์', 'หนองบัวลำภู', 'หนองคาย', 'บึงกาฬ', 'ชัยภูมิ', 'เลย', 'อำนาจเจริญ'],
                        'ใต้': ['สงขลา', 'สตูล', 'พัทลุง', 'ตรัง', 'กระบี่', 'ภูเก็ต', 'ระนอง', 'ชุมพร', 'นครศรีธรรมราช', 'สุราษฎร์ธานี', 'นราธิวาส', 'ยะลา', 'ปัตตานี']
                    };

                    let regionName = '';
                    for (const [region, provinces] of Object.entries(regionMap)) {
                        if (provinces.includes(provinceName)) {
                            regionName = region;
                            break;
                        }
                    }

                    if (regionName && elements.region) {
                        elements.region.value = regionName;
                        console.log('Region set to:', regionName); // Debug
                    }

                    updateStatus('📍 ดึงที่อยู่สำเร็จ', 3000);
                } else {
                    console.log('No result from API'); // Debug
                    updateStatus('📍 ไม่พบที่อยู่จากพิกัดนี้', 3000);
                }
            } catch (error) {
                console.error('Error fetching address for edit:', error);
                updateStatus('❌ ดึงข้อมูลที่อยู่ล้มเหลว: ' + error.message, 3000);
            }
        }


        // ฟังก์ชันเลือกตำแหน่งปัจจุบันที่แก้ไขแล้ว
function selectCurrentLocation() {
    try {
        if (!editMap || typeof editMap.location !== 'function') {
            updateStatus('❌ แผนที่แก้ไขยังไม่พร้อมใช้งาน', 3000);
            return;
        }

        const center = editMap.location();
        if (!center || typeof center.lat === 'undefined' || typeof center.lon === 'undefined') {
            updateStatus('❌ ไม่พบพิกัดกึ่งกลางของแผนที่', 3000);
            return;
        }

        // กรอก lat/lon ลงฟอร์ม
        const latInput = document.getElementById('edit_lat');
        const lonInput = document.getElementById('edit_lon');
        
        if (latInput) latInput.value = center.lat.toFixed(6);
        if (lonInput) lonInput.value = center.lon.toFixed(6);

        // ย้าย marker ไปยังตำแหน่งใหม่
        if (editCurrentMarker) {
            try {
                editCurrentMarker.location({ lon: center.lon, lat: center.lat });
            } catch (markerError) {
                console.warn('Could not move marker:', markerError);
            }
        }

        // ดึงที่อยู่และใส่ข้อมูลฟอร์ม
        fetchAddressForEdit(center.lat, center.lon);

        updateStatus(`📍 เลือกพิกัดใหม่: ${center.lat.toFixed(6)}, ${center.lon.toFixed(6)}`, 3000);
    } catch (error) {
        console.error('Error selecting current location:', error);
        updateStatus('❌ เกิดข้อผิดพลาดในการเลือกตำแหน่ง', 3000);
    }
}

// ฟังก์ชันปิด modal ที่แก้ไขแล้ว
function closeEditModal() {
    try {
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.classList.remove('edit-modal');
            modal.style.display = 'none';
        }

        // ล้างข้อมูลการแก้ไข
        editingIndex = null;
        editingMarkerData = null;

        // ล้างแผนที่แก้ไขอย่างปลอดภัย
        if (editMap) {
            try {
                if (editCurrentMarker) {
                    editMap.Overlays.remove(editCurrentMarker);
                }
                editMap.destroy();
            } catch (e) {
                console.warn('Error destroying edit map:', e);
            }
            editMap = null;
        }
        
        editCurrentMarker = null;

        updateStatus('📝 ปิดหน้าต่างแก้ไขแล้ว', 3000);
    } catch (error) {
        console.error('Error closing edit modal:', error);
    }
}



        // เพิ่ม event listener สำหรับฟอร์มแก้ไขและสร้างใหม่หลังจาก DOM โหลดเสร็จแล้ว
        document.addEventListener('DOMContentLoaded', function () {
            const editMarkerForm = document.getElementById('editMarkerForm');
            if (editMarkerForm) {
                editMarkerForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // ดึงค่าจากฟอร์ม
                    const name = document.getElementById('edit_fullName').value.trim();
                    const lat = parseFloat(document.getElementById('edit_lat').value);
                    const lon = parseFloat(document.getElementById('edit_lon').value);
                    const shelterType = document.getElementById('edit_shelterType').value;
                    const phone = document.getElementById('edit_phone').value.trim();
                    const region = document.getElementById('edit_region').value;
                    const province = document.getElementById('edit_province').value.trim();
                    const district = document.getElementById('edit_district').value.trim();
                    const subdistrict = document.getElementById('edit_subdistrict').value.trim();
                    const village = document.getElementById('edit_village').value.trim();
                    const zipcode = document.getElementById('edit_zipcode').value.trim();
                    const place = document.getElementById('edit_place').value.trim();
                    const electricity = document.getElementById('edit_electricity').value;
                    const water = document.getElementById('edit_water').value;
                    const wifi = document.getElementById('edit_wifi').value;
                    const pet = document.getElementById('edit_pet').value;
                    const tent = document.getElementById('edit_tent').value;
                    const toilet = document.getElementById('edit_toilet').value.trim();
                    const parking = document.getElementById('edit_parking').value.trim();
                    const canSupport = document.getElementById('edit_canSupport').value;
                    const currentSupport = document.getElementById('edit_currentSupport').value;
                    const status = document.getElementById('edit_status').value;
                    const active = (status === 'เปิด');

                    // validate
                    if (!name) {
                        updateStatus('❌ กรุณากรอกชื่อ-สกุล', 3000);
                        alert('กรุณากรอกชื่อ-สกุล');
                        return;
                    }

                    // **เช็คว่าเป็นโหมดเพิ่มใหม่หรือแก้ไข**
                    if (editingIndex === null) {
                        // ------------------------
                        // โหมด "เพิ่มศูนย์พักพิงใหม่"
                        // ------------------------
                        await addMarkerWithData();  // ฟังก์ชันเดิมที่บันทึกลง database และสร้างหมุดใหม่
                        closeEditModal();
                        updateStatus("✅ เพิ่มศูนย์พักพิงใหม่สำเร็จ!", 5000);
                        return;
                    }

                    // ------------------------
                    // โหมด "แก้ไขศูนย์พักพิง"
                    // ------------------------
                    try {
                        const updatedData = {
                            shelterType: shelterType || '',
                            name: name,
                            phone: phone || '',
                            region: region || '',
                            province: province || '',
                            district: district || '',
                            subdistrict: subdistrict || '',
                            village: village || '',
                            zipcode: zipcode || '',
                            address: place || '',
                            lat: lat,
                            lon: lon,
                            electricity: electricity || '',
                            water: water || '',
                            wifi: wifi || '',
                            pet: pet || '',
                            tent: tent || '',
                            toilet: toilet || '',
                            parking: parking || '',
                            capacity: canSupport ? parseInt(canSupport) : null,
                            currentSupport: currentSupport ? parseInt(currentSupport) : null,
                            active: active,
                            updatedAt: new Date()
                        };

                        const markerId = markers[editingIndex].id;
                        const markerRef = window.doc(window.db, 'markers', markerId);

                        // update ข้อมูลใน Firestore
                        await window.updateDoc(markerRef, updatedData);

                        // ลบ marker เก่าบนแผนที่
                        if (markers[editingIndex].marker) {
                            map.Overlays.remove(markers[editingIndex].marker);
                        }

                        // สร้าง marker ใหม่
                        const newMarker = createMarker(
                            lat, lon, name, place, active, updatedData.capacity,
                            markerId, editingIndex, updatedData
                        );
                        map.Overlays.add(newMarker);

                        // update array markers
                        markers[editingIndex] = {
                            ...markers[editingIndex],
                            ...updatedData,
                            marker: newMarker
                        };

                        updateMarkersList();
                        updateStatus("✅ บันทึกการแก้ไขข้อมูลสำเร็จ!", 5000);
                        closeEditModal();
                    } catch (err) {
                        console.error('Error updating marker:', err);
                        updateStatus('❌ เกิดข้อผิดพลาดในการแก้ไข: ' + err.message, 5000);
                        alert("เกิดข้อผิดพลาดในการอัปเดต: " + err.message);
                    }
                });
            } else {
                console.error('editMarkerForm element not found');
            }
        });


        async function deleteMarkerFromPopup(markerId, index) {
            if (map && map.InfoWindow && typeof map.InfoWindow.close === 'function') {
                map.InfoWindow.close();
            }
            await deleteMarker(markerId, index); // เรียกฟังก์ชันลบหลัก
        }

        function clearForm() {
            document.getElementById('markerForm').reset();
            document.getElementById('lat').value = '';
            document.getElementById('lon').value = '';
            document.getElementById('subdistrict').value = '';
            document.getElementById('district').value = '';
            document.getElementById('province').value = '';
            document.getElementById('zipcode').value = '';
        }

        function updateStatus(message, duration = 0) {
            var statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;

                // Clear previous timeout if exists
                if (statusTimeout) {
                    clearTimeout(statusTimeout);
                }

                // Set new timeout if duration is provided and greater than 0
                if (duration > 0) {
                    statusTimeout = setTimeout(() => {
                        statusDiv.textContent = ''; // Clear the message
                    }, duration);
                }
            }
        }

        // ฟังก์ชันสำหรับเปิด Google Maps เพื่อดูเส้นทาง
        function getDirections(lat, lon) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const originLat = position.coords.latitude;
                    const originLon = position.coords.longitude;
                    // ใช้ domain ที่อนุญาตสำหรับ Google Maps
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLon}&destination=${lat},${lon}&travelmode=driving`;
                    window.open(googleMapsUrl, '_blank');
                }, function (error) {
                    alert('ไม่สามารถระบุตำแหน่งปัจจุบันของคุณได้: ' + error.message);
                    // Fallback: open without origin
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
                    window.open(googleMapsUrl, '_blank');
                });
            } else {
                alert('เบราว์เซอร์ของคุณไม่รองรับ Geolocation');
                // Fallback: open without origin
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
                window.open(googleMapsUrl, '_blank');
            }
        }



    </script>
    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <h2 class="edit-modal-header">✏️ แก้ไขข้อมูลศูนย์พักพิง</h2>
            <button onclick="closeEditModal()" class="edit-modal-close">✕</button>

            <div class="edit-grid">
                <!-- ฟอร์มแก้ไข -->
                <div class="edit-form-section">
                    <form id="editMarkerForm">
                        <div class="form-group">
                            <label class="form-label" for="edit_shelterType">ประเภทศูนย์พักพิง *</label>
                            <select id="edit_shelterType" class="form-input" required>
                                <option value="">-- เลือกประเภท --</option>
                                <option value="ตามแผน">ตามแผน</option>
                                <option value="นอกแผน">นอกแผน</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_fullName">ชื่อ-สกุล *</label>
                            <input type="text" id="edit_fullName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_phone">หมายเลขโทรศัพท์ *</label>
                            <input type="text" id="edit_phone" class="form-input" required pattern="[0-9]{9,10}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_region">ภาค *</label>
                            <select id="edit_region" class="form-input" required>
                                <option value="">-- เลือกภาค --</option>
                                <option value="เหนือ">เหนือ</option>
                                <option value="กลาง">กลาง</option>
                                <option value="ตะวันออกเฉียงเหนือ">ตะวันออกเฉียงเหนือ</option>
                                <option value="ตะวันออก">ตะวันออก</option>
                                <option value="ตะวันตก">ตะวันตก</option>
                                <option value="ใต้">ใต้</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_province">จังหวัด *</label>
                            <input type="text" id="edit_province" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_district">เขต/อำเภอ *</label>
                            <input type="text" id="edit_district" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_subdistrict">แขวง/ตำบล *</label>
                            <input type="text" id="edit_subdistrict" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_village">หมู่บ้าน</label>
                            <input type="text" id="edit_village" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_zipcode">รหัสไปรษณีย์</label>
                            <input type="text" id="edit_zipcode" class="form-input" pattern="[0-9]{5}">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_place">สถานที่</label>
                            <input type="text" id="edit_place" class="form-input">
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label">ละติจูด</label>
                                <input type="text" id="edit_lat" class="form-input" placeholder="ละติจูด">
                            </div>
                            <div style="flex:1;">
                                <label class="form-label">ลองจิจูด</label>
                                <input type="text" id="edit_lon" class="form-input" placeholder="ลองจิจูด">
                            </div>
                        </div>

                        <!-- แผนที่สำหรับเลือกตำแหน่งใหม่ -->
                        <div class="form-group">
                            <label class="form-label">แผนที่สำหรับเลือกตำแหน่งใหม่</label>
                            <div id="editMapContainer" class="edit-map-container">
                                <div id="editMap" class="edit-map"></div>
                            </div>
                            <button type="button" class="btn-form"
                                style="margin-top:10px;background:linear-gradient(135deg,#dc2626,#ef4444);"
                                onclick="selectCurrentLocation()">
                                📍 เลือกจุดนี้
                            </button>
                        </div>



                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="edit_electricity">ไฟฟ้า</label>
                                <select id="edit_electricity" class="form-input">
                                    <option value="มี">มี</option>
                                    <option value="ไม่มี">ไม่มี</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_water">ประปา</label>
                                <select id="edit_water" class="form-input">
                                    <option value="มี">มี</option>
                                    <option value="ไม่มี">ไม่มี</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_wifi">Wifi</label>
                                <select id="edit_wifi" class="form-input">
                                    <option value="มี">มี</option>
                                    <option value="ไม่มี">ไม่มี</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group input-group">
                            <div style="flex:1;">
                                <label class="form-label" for="edit_pet">รองรับสัตว์เลี้ยง</label>
                                <select id="edit_pet" class="form-input">
                                    <option value="มี">มี</option>
                                    <option value="ไม่มี">ไม่มี</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_tent">สถานที่กางเต็นท์</label>
                                <select id="edit_tent" class="form-input">
                                    <option value="มี">มี</option>
                                    <option value="ไม่มี">ไม่มี</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <label class="form-label" for="edit_toilet">สุขา (จำนวน)</label>
                                <input type="text" id="edit_toilet" class="form-input" placeholder="จำนวนสุขา">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_parking">ที่จอดรถ (จำนวน)</label>
                            <input type="text" id="edit_parking" class="form-input" placeholder="จำนวนที่จอดรถ">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_canSupport">รองรับผู้พักพิง (คน)</label>
                            <input type="number" id="edit_canSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_currentSupport">จำนวนผู้พักพิง (คน)</label>
                            <input type="number" id="edit_currentSupport" class="form-input" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="edit_status">สถานะ *</label>
                            <select id="edit_status" class="form-input" required>
                                <option value="เปิด">เปิด</option>
                                <option value="ปิด">ปิด</option>
                            </select>
                        </div>

                        <button type="submit" id="editMarkerBtn" class="btn-form"
                            style="margin-top:20px; background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                            💾 บันทึกการแก้ไข
                        </button>
                    </form>
                </div>


            </div>
        </div>
    </div>
</body>

</html>
